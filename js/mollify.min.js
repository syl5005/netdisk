var mollifyDefaults={language:{"default":"en",options:["en"]},"view-url":!1,"app-element-id":"mollify","service-path":"backend/","limited-http-methods":!1,"list-view-columns":{name:{width:250},size:{},"file-modified":{width:150}},"html5-uploader":{maxChunkSize:0},dnd:{dragimages:{"filesystemitem-file":"css/images/mimetypes64/empty.png","filesystemitem-folder":"css/images/mimetypes64/folder.png","filesystemitem-many":"css/images/mimetypes64/application_x_cpio.png"}}};!function(e){"use strict";function h(e,t,n,r){typeof t=="undefined"&&(t=0),typeof n=="undefined"&&(n=" "),typeof r=="undefined"&&(r=l);if(t+1>=e.length)switch(r){case f:e=(new Array(t+1-e.length)).join(n)+e;break;case c:var i=t-e.length,s=Math.ceil(i/2),o=i-s;e=(new Array(o+1)).join(n)+e+(new Array(s+1)).join(n);break;default:e+=(new Array(t+1-e.length)).join(n)}return e}var t={App:{},view:{},ui:{},events:{},service:{},filesystem:{},plugins:{},features:{},dom:{},templates:{}};t._time=(new Date).getTime(),t._hiddenInd=0,t.settings=!1,t.session=!1,t.App.init=function(n,r){window.Modernizr.testProp("touch"),t.App._initialized=!1,t.App._views={},t.App.pageUrl=t.request.getBaseUrl(window.location.href),t.App.pageParams=t.request.getParams(window.location.href),t.App.mobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t.plugins.register(new t.plugin.Core);if(r)for(var i=0,s=r.length;i<s;i++)t.plugins.register(r[i]);t.settings=e.extend({},mollifyDefaults,n),t.service.init(t.settings["limited-http-methods"]);var o=function(){t.service.get("session/info/3").fail(function(){(new t.ui.FullErrorView("Failed to initialize Mollify")).show()}).done(function(e){t.events.dispatch("session/start",e)})};t.events.addEventHandler(function(e){e.type=="session/start"?t.App._onSessionStart(e.payload):e.type=="session/end"&&(t.session=!1,t.filesystem.init([]),o())}),t.settings["view-url"]&&(window.onpopstate=function(e){t.App.onRestoreState(document.location.href,e.state)}),o()},t.App.getElement=function(){return e("#"+t.settings["app-element-id"])},t.App._onSessionStart=function(e){t.session=e,t.session.id=t.session.session_id,t.session.admin=t.session.default_permission=="A",t.filesystem.init(t.session.folders);var n=function(){(new t.ui.FullErrorView("Failed to initialize Mollify")).show()};t.App._initialized?t.ui.initializeLang().done(t.App._start).fail(n):t.ui.initialize().done(function(){t.plugins.initialize().done(function(){t.App._initialized=!0,t.App._start()}).fail(n)}).fail(n)},t.App._start=function(){t.App.activeView=!1,t.App.activeViewId=null;var e=!1;t.App.pageParams.v&&t.App.pageParams.v.length>0&&(e=t.App.pageParams.v.split("/")),t.App._activateView(e)},t.App._activateView=function(e){var n=function(n){n?(t.App.activeView=n,t.App.activeViewId=e[0]):!t.session||!t.session.authenticated?(t.App.activeView=new t.view.LoginView,t.App.activeViewId="login"):(t.App.activeView=new t.view.MainView,t.App.activeViewId="main"),t.App.activeView.init(t.App.getElement(),e)};if(e){var r=!!t.App._views[e[0]],i=r&&t.App.activeViewId==e[0]||!r&&t.App.activeViewId=="main";i?t.App.activeView.onRestoreView(e):t.App._getView(e,n)}else n()},t.App._getView=function(e,n){var r=t.App._views[e[0]];if(r&&r.getView){var i=r.getView(e,t.App.pageParams);i&&i.done?i.done(n):n(i)}else n(!1)},t.App.onRestoreState=function(e,n){if(!t.settings["view-url"])return;if(!t.App.activeView)return;if(!t.session.user_id||t.session.user_id!=n.user_id)return;var r=t.request.getParams(e);if(!r.v||r.v.length<1)return;var i=r.v.split("/");t.App._activateView(i)},t.App.storeView=function(e){if(!t.settings["view-url"])return;var n={user_id:t.session.user_id};window.history&&window.history.pushState(n,"","?v="+e)},t.App.registerView=function(e,n){t.App._views[e]=n},t.App.openPage=function(e){window.location=t.App.getPageUrl(e)},t.App.getPageUrl=function(e){return t.App.pageUrl+"?v="+e},t.getItemDownloadInfo=function(e){if(!e)return!1;var n=!1;return window.isArray(e)?e.length===0&&(n=e[0]):n=e,n&&n.is_file?{name:n.name,url:t.filesystem.getDownloadUrl(n)}:n?t.plugins.exists("plugin-archiver")?{name:n.name+".zip",url:t.plugins.get("plugin-archiver").getDownloadCompressedUrl(e)}:!1:!1},t.resourceUrl=function(e){if(!t.settings["resource-map"])return e;var n=t.helpers.breakUrl(e);if(!n)return e;var r=t.settings["resource-map"][n.path];return r===undefined?e:r===!1?!1:r+n.paramsString},t.request={getParam:function(e){if(e=(new RegExp("[?&]"+encodeURIComponent(e)+"=([^&]*)")).exec(location.search))return decodeURIComponent(e[1])},getParams:function(){return t.helpers.getUrlParams(location.search)},getBaseUrl:function(e){var t=e.lastIndexOf("?");t>=0&&(e=e.substring(0,t+1));var n=e.lastIndexOf("/");return e.substring(0,n+1)}};var n=t.events;n._handlers=[],n.addEventHandler=function(e){n._handlers.push(e)},n.dispatch=function(t,r){var i={type:t,payload:r};e.each(n._handlers,function(e,t){t(i)})};var r=t.service;r.init=function(e){r._limitedHttpMethods=!!e},r.url=function(e,n){if(e.startsWith("http"))return e;var r=t.settings["service-path"]+"r.php/"+e;return n?t.App.pageUrl+r:r},r.get=function(e,t,n){return r._do("GET",e,null)},r.post=function(e,t){return r._do("POST",e,t)},r.put=function(e,t){return r._do("PUT",e,t)},r.del=function(e,t){return r._do("DELETE",e,t)},r._do=function(n,i,s){var o=n,u=r._limitedHttpMethods&&(o=="PUT"||o=="DELETE");return u&&(o="POST"),e.ajax({type:o,url:r.url(i),processData:!1,data:s?JSON.stringify(s):null,contentType:"application/json",dataType:"json",beforeSend:function(e){t.session&&t.session.id&&e.setRequestHeader("mollify-session-id",t.session.id),(r._limitedHttpMethods||u)&&e.setRequestHeader("mollify-http-method",n)}}).pipe(function(t){return t?t.result:e.Deferred().reject({code:999})},function(n){var r=!1,i=!1;n.responseText&&n.responseText.startsWith("{")&&(r=JSON.parse(n.responseText)),r||(r={code:999});var s={handled:!1};r.code==100&&t.session&&t.session.authenticated&&(t.events.dispatch("session/end"),s.handled=!0);var o=e.Deferred();return setTimeout(function(){o.fail(function(e){s.handled||t.ui.dialogs.showError(e)})},0),o.rejectWith(s,[r])}).promise()};var i=t.filesystem;i.init=function(e){t.filesystem.roots=[],t.filesystem.rootsById={};if(e&&t.session.authenticated){t.filesystem.roots=e;for(var n=0,r=e.length;n<r;n++)t.filesystem.rootsById[e[n].id]=e[n]}},i.getDownloadUrl=function(e){if(!e.is_file)return!1;var n=t.service.url("filesystem/"+e.id,!0);return t.App.mobile&&(n=n+(n.indexOf("?")>=0?"&":"?")+"m=1"),n},i.getUploadUrl=function(e){return!e||e.is_file?null:t.service.url("filesystem/"+e.id+"/files/")+"?format=binary"},i.itemDetails=function(e,n){return t.service.post("filesystem/"+e.id+"/details/",{data:n})},i.folderInfo=function(e,n,r){return t.service.post("filesystem/"+(e?e:"roots")+"/info/"+(n?"?h=1":""),{data:r})},i.findFolder=function(e,n){return t.service.post("filesystem/find/",{folder:e,data:n})},i.folders=function(n){if(n==null){var r=e.Deferred();return r.resolve(i.roots),r.promise()}return t.service.get("filesystem/"+n.id+"/folders/")},i.copy=function(n,r){if(!n)return;if(window.isArray(n)&&n.length>1){if(!r){var s=e.Deferred();return t.ui.dialogs.folderSelector({title:t.ui.texts.get("copyMultipleFileDialogTitle"),message:t.ui.texts.get("copyMultipleFileMessage",[n.length]),actionTitle:t.ui.texts.get("copyFileDialogAction"),handler:{onSelect:function(t){e.when(i._copyMany(n,t)).then(s.resolve,s.reject)},canSelect:function(e){return i.canCopyTo(n,e)}}}),s.promise()}return i._copyMany(n,r)}window.isArray(n)&&(n=n[0]);if(!r){var o=e.Deferred();return t.ui.dialogs.folderSelector({title:t.ui.texts.get("copyFileDialogTitle"),message:t.ui.texts.get("copyFileMessage",[n.name]),actionTitle:t.ui.texts.get("copyFileDialogAction"),handler:{onSelect:function(t){e.when(i._copy(n,t)).then(o.resolve,o.reject)},canSelect:function(e){return i.canCopyTo(n,e)}}}),o.promise()}return i._copy(n,r)},i.copyHere=function(n,r){if(!n)return;if(!r){var s=e.Deferred();return t.ui.dialogs.input({title:t.ui.texts.get("copyHereDialogTitle"),message:t.ui.texts.get("copyHereDialogMessage"),defaultValue:n.name,yesTitle:t.ui.texts.get("copyFileDialogAction"),noTitle:t.ui.texts.get("dialogCancel"),handler:{isAcceptable:function(e){return!!e&&e.length>0&&e!=n.name},onInput:function(t){e.when(i._copyHere(n,t)).then(s.resolve,s.reject)}}}),s.promise()}return i._copyHere(n,r)},i.canCopyTo=function(e,t){if(window.isArray(e)){for(var n=0,r=e.length;n<r;n++)if(!i.canCopyTo(e[n],t))return!1;return!0}return t.is_file?!1:e.id==t.id?!1:e.parent_id==t.id?!1:!0},i.canMoveTo=function(e,t){if(window.isArray(e)){for(var n=0,r=e.length;n<r;n++)if(!i.canMoveTo(e[n],t))return!1;return!0}return t.is_file?!1:!t.is_file&&e.root_id==t.root_id&&t.path.startsWith(e.path)?!1:e.id==t.id?!1:e.parent_id==t.id?!1:!0},i._copyHere=function(e,n){return t.service.post("filesystem/"+e.id+"/copy/",{name:n}).done(function(r){t.events.dispatch("filesystem/copy",{items:[e],name:n})})},i._copy=function(e,n){return t.service.post("filesystem/"+e.id+"/copy/",{folder:n.id}).done(function(r){t.events.dispatch("filesystem/copy",{items:[e],to:n})})},i._copyMany=function(e,n){return t.service.post("filesystem/items/",{action:"copy",items:e,to:n}).done(function(r){t.events.dispatch("filesystem/copy",{items:e,to:n})})},i.move=function(n,r){if(!n)return;if(window.isArray(n)&&n.length>1){if(!r){var s=e.Deferred();return t.ui.dialogs.folderSelector({title:t.ui.texts.get("moveMultipleFileDialogTitle"),message:t.ui.texts.get("moveMultipleFileMessage",[n.length]),actionTitle:t.ui.texts.get("moveFileDialogAction"),handler:{onSelect:function(t){e.when(i._moveMany(n,t)).then(s.resolve,s.reject)},canSelect:function(e){return i.canMoveTo(n,e)}}}),s.promise()}return i._moveMany(n,r)}window.isArray(n)&&(n=n[0]);if(!r){var o=e.Deferred();return t.ui.dialogs.folderSelector({title:t.ui.texts.get("moveFileDialogTitle"),message:t.ui.texts.get("moveFileMessage",[n.name]),actionTitle:t.ui.texts.get("moveFileDialogAction"),handler:{onSelect:function(t){e.when(i._move(n,t)).then(o.resolve,o.reject)},canSelect:function(e){return i.canMoveTo(n,e)}}}),o.promise()}return i._move(n,r)},i._move=function(e,n){return t.service.post("filesystem/"+e.id+"/move/",{id:n.id}).done(function(r){t.events.dispatch("filesystem/move",{items:[e],to:n})})},i._moveMany=function(e,n){return t.service.post("filesystem/items/",{action:"move",items:e,to:n}).done(function(r){t.events.dispatch("filesystem/move",{items:e,to:n})})},i.rename=function(n,r){if(!r||r.length===0){var s=e.Deferred();return t.ui.dialogs.input({title:t.ui.texts.get(n.is_file?"renameDialogTitleFile":"renameDialogTitleFolder"),message:t.ui.texts.get("renameDialogNewName"),defaultValue:n.name,yesTitle:t.ui.texts.get("renameDialogRenameButton"),noTitle:t.ui.texts.get("dialogCancel"),handler:{isAcceptable:function(e){return!!e&&e.length>0&&e!=n.name},onInput:function(t){e.when(i._rename(n,t)).then(s.resolve,s.reject)}}}),s.promise()}return i._rename(n,r)},i._rename=function(e,n){return t.service.put("filesystem/"+e.id+"/name/",{name:n}).done(function(r){t.events.dispatch("filesystem/rename",{items:[e],name:n})})},i._handleDenied=function(n,r,i,s,o){var u=e.Deferred(),a=[],f=function(e){if(!window.isArray(i.target))return i.target;for(var t=0,n=i.target.length;t<n;t++)if(i.target[t].id==e)return i.target[t];return null};for(var l in i.items){var c=t.plugins.get(l);if(!c||!c.actionValidationHandler)return!1;var h=c.actionValidationHandler();a.push(h);var p=i.items[l];for(var d=0,v=p.length;d<v;d++){var m=p[d];m.item=f(m.item)}}var g=[],y=[],b=[],w=!0;for(var E=0,S=a.length;E<S;E++){var x=a[E].getValidationMessages(n,i.items[l],i);for(var T=0,N=x.length;T<N;T++){var C=x[T];b.push(C.acceptKey),g.push(C.message),C.acceptable||y.push(C.message)}}return y.length===0?t.ui.dialogs.confirmActionAccept(o,g,function(){u.resolve(b)},u.reject):(t.ui.dialogs.showActionDeniedMessage(s,y),u.reject()),u},i.del=function(n){if(!n)return;var r=e.Deferred();return window.isArray(n)&&n.length>1?(i._delMany(n).done(r.resolve).fail(function(e){e.code==109&&e.data&&e.data.items?(this.handled=!0,i._handleDenied("delete",n,e.data,t.ui.texts.get("actionDeniedDeleteMany"),t.ui.texts.get("actionAcceptDeleteMany",n.length)).done(function(e){i._delMany(n,e).done(r.resolve).fail(r.reject)}).fail(function(){r.reject(e)})):r.reject(e)}),r.promise()):(window.isArray(n)&&(n=n[0]),i._del(n).done(r.resolve).fail(function(e){e.code==109&&e.data&&e.data.items?(this.handled=!0,i._handleDenied("delete",n,e.data,t.ui.texts.get("actionDeniedDelete",n.name),t.ui.texts.get("actionAcceptDelete",n.name)).done(function(e){i._del(n,e).done(r.resolve).fail(r.reject)}).fail(function(){r.reject(e)})):r.reject(e)}),r.promise())},i._del=function(e,n){return t.service.del("filesystem/"+e.id,n?{acceptKeys:n}:null).done(function(n){t.events.dispatch("filesystem/delete",{items:[e]})})},i._delMany=function(e,n){return t.service.post("filesystem/items/",{action:"delete",items:e,acceptKeys:n?n:null}).done(function(n){t.events.dispatch("filesystem/delete",{items:e})})},i.createFolder=function(e,n){return t.service.post("filesystem/"+e.id+"/folders/",{name:n}).done(function(r){t.events.dispatch("filesystem/createfolder",{items:[e],name:n})})};var s=t.plugins;s._list={},s.register=function(e){var t=e.id;if(!t)return;s._list[t]=e},s.initialize=function(n){var r=e.Deferred(),i=[];for(var o in s._list){var u=s._list[o];u.initialize&&u.initialize();if(u.resources){var a=u.backendPluginId||o;u.resources.texts&&(t.settings.texts_js?i.push(t.dom.importScript(t.plugins.getJsLocalizationUrl(a))):i.push(t.ui.texts.loadPlugin(a))),u.resources.css&&t.dom.importCss(t.plugins.getStyleUrl(a))}}return i.length===0?r.resolve().promise():(e.when.apply(e,i).done(r.resolve).fail(r.reject),r.promise())},s.get=function(e){return window.def(e)?s._list[e]:s._list},s.exists=function(e){return!!s._list[e]},s.url=function(e,n,r){var i=t.settings["service-path"]+"plugin/"+e;return n?i+(r?"/admin/":"/client/")+n:i},s.adminUrl=function(e,t){return s.url(e)+"/admin/"+t},s.getLocalizationUrl=function(e){return t.settings["service-path"]+"plugin/"+e+"/localization/texts_"+t.ui.texts.locale+".json"},s.getStyleUrl=function(e,t){return s.url(e,"style.css",t)},s.getItemContextRequestData=function(e){var t={};for(var n in s._list){var r=s._list[n];if(!r.itemContextRequestData)continue;var i=r.itemContextRequestData(e);if(!i)continue;t[n]=i}return t},s.getItemContextPlugins=function(e,t){var n={};if(!t)return n;var r=t.details;if(!r||!r.plugins)return n;for(var i in s._list){var o=s._list[i];if(!o.itemContextHandler)continue;var u=o.itemContextHandler(e,t,r.plugins[i]);u&&(n[i]=u)}return n},s.getItemCollectionPlugins=function(e,t){var n={};if(!e||!window.isArray(e)||e.length<1)return n;for(var r in s._list){var i=s._list[r];if(!i.itemCollectionHandler)continue;var o=i.itemCollectionHandler(e,t);o&&(n[r]=o)}return n},s.getMainViewPlugins=function(){var e=[];for(var t in s._list){var n=s._list[t];if(!n.mainViewHandler)continue;e.push(n)}return e},s.getFileViewPlugins=function(){var e=[];for(var t in s._list){var n=s._list[t];if(!n.fileViewHandler)continue;e.push(n)}return e},s.getConfigViewPlugins=function(){var e=[];for(var t in s._list){var n=s._list[t];if(!n.configViewHandler)continue;e.push(n)}return e};var o=t.features;o.hasFeature=function(e){return t.session.features&&t.session.features[e]};var u=t.templates;u._loaded=[],u.url=function(e){var n=t.settings["template-url"]||"templates/";return t.helpers.noncachedUrl(t.resourceUrl(n+e))},u.load=function(n,r){var i=e.Deferred();return u._loaded.indexOf(n)>=0?i.resolve():(e.get(r?t.resourceUrl(r):u.url(n)).done(function(t){u._loaded.push(n),e("body").append(t),i.resolve()}).fail(function(e){i.reject()}),i)};var a=t.dom;a._hiddenLoaded=[],a.importScript=function(n){var r=t.resourceUrl(n);if(!r)return e.Deferred().resolve().promise();var i=e.Deferred();return e.getScript(r,i.resolve).fail(i.reject),i.promise()},a.importCss=function(n){var r=t.resourceUrl(n);if(!r)return;var i=e("<link>");i.attr({type:"text/css",rel:"stylesheet",href:t.helpers.noncachedUrl(r)}),e("head").append(i)},a.loadContent=function(n,r,i){if(a._hiddenLoaded.indexOf(n)>=0){i&&i();return}var s=t.resourceUrl(r);if(!s){i&&i();return}var o="mollify-tmp-"+t._hiddenInd++;e('<div id="'+o+'" style="display:none"/>').appendTo(e("body")).load(t.helpers.noncachedUrl(s),function(){a._hiddenLoaded.push(n),i&&i()})},a.loadContentInto=function(e,n,r,i){var s=t.resourceUrl(n);if(!s)return;e.load(t.helpers.noncachedUrl(s),function(){i&&t.ui.process(e,i,r),typeof r=="function"?r():r.onLoad&&r.onLoad(e)})},a.template=function(n,r,i){var s=n;return t.settings["resource-map"]&&t.settings["resource-map"]["template:"+n]&&(s=t.settings["resource-map"]["template:"+n]),e("#"+s).tmpl(r,i)},t.helpers={getPluginActions:function(t){var n=[];if(t)for(var r in t){var i=t[r];i.actions&&(n.push({title:"-",type:"separator"}),e.merge(n,i.actions))}var s=[],o=-1;for(var u=0,a=n.length;u<a;u++){var f=n[u];f.group=="download"&&(o<0&&(o=u),s.push(f))}if(s.length>1){for(var l=1,c=s.length;l<c;l++)n.remove(s[l]);n[o]={type:"submenu",items:s,title:s[0].title,group:s[0].group,primary:s[0]}}return n},getPrimaryActions:function(e){if(!e)return[];var t=[],n=function(e){for(var n=0,r=e.length;n<r;n++){var i=e[n];(i.type=="primary"||i.group=="download")&&t.push(i)}};return n(e),t},getSecondaryActions:function(e){if(!e)return[];var n=[];for(var r=0,i=e.length;r<i;r++){var s=e[r];if(s.id=="download"||s.type=="primary")continue;n.push(s)}return t.helpers.cleanupActions(n)},cleanupActions:function(e){if(!e)return[];var t=-1;for(var n=e.length-1,r=0;n>=r;n--){var i=e[n];if(i.type!="separator"&&i.title!="-"){t=n;break}}if(t<0)return[];var s=-1;for(var o=0;o<=t;o++){var u=e[o];if(u.type!="separator"&&u.title!="-"){s=o;break}}e=e.splice(s,t-s+1);var a=!1;for(var f=e.length-1,l=0;f>=l;f--){var c=e[f],h=c.type=="separator"||c.title=="-";h&&a&&e.splice(f,1),a=h}return e},breakUrl:function(e){var n=e.split("?");return{path:n[0],params:t.helpers.getUrlParams(e),paramsString:n.length>1?"?"+n[1]:""}},getUrlParams:function(t){var n={};return e.each(t.substring(1).split("&"),function(e,t){var r=t.split("=");if(!r||r.length<2)return;n[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}),n},urlWithParam:function(e,t,n){var r=t;return n&&(r=t+"="+encodeURIComponent(n)),e+(window.strpos(e,"?")?"&":"?")+r},noncachedUrl:function(e){return t.helpers.urlWithParam(e,"_="+t._time)},formatDateTime:function(e,t){var n=e.toString(t);return n},parseInternalTime:function(e){if(!e||e==null||typeof e!="string"||e.length!=14)return null;var t=new Date;return t.setYear(e.substring(0,4)),t.setMonth(e.substring(4,6)-1),t.setDate(e.substring(6,8)),t.setHours(e.substring(8,10)),t.setMinutes(e.substring(10,12)),t.setSeconds(e.substring(12,14)),t},formatInternalTime:function(e){return e?t.helpers.formatDateTime(e,"yyyyMMddHHmmss"):null},mapByKey:function(e,t){var n={};if(!e)return n;for(var r=0,i=e.length;r<i;r++){var s=e[r];if(!window.def(s))continue;var o=s[t];if(!window.def(o))continue;n[o]=s}return n},extractValue:function(e,t){var n=[];for(var r=0,i=e.length;r<i;r++){var s=e[r];n.push(s[t])}return n},filter:function(t,n){var r=[];return e.each(t,function(e,t){n(t)&&r.push(t)}),r},arrayize:function(e){var t=[];return window.isArray(e)?e:(t.push(e),t)}},window.mollify=t,window.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"},typeof String.prototype.trim!="function"&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),typeof String.prototype.startsWith!="function"&&(String.prototype.startsWith=function(e){return!e||e.length===0?!1:this.substring(0,e.length)==e}),window.def=function(e){return typeof e!="undefined"},Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){for(var n=t||0,r=this.length;n<r;n++)if(this[n]===e)return n;return-1}),Array.prototype.remove||(Array.prototype.remove=function(e,t){typeof t=="undefined"&&typeof e=="object"&&(e=this.indexOf(e));var n=this.slice((t||e)+1||this.length);return this.length=e<0?this.length+e:e,this.push.apply(this,n)}),window.strpos=function(e,t,n){var r=(e+"").indexOf(t,n||0);return r===-1?!1:r};var f=1,l=2,c=3;window.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="",n,r,i,s,o,u,a,f=0;e=window.Base64._utf8_encode(e);while(f<e.length)n=e.charCodeAt(f++),r=e.charCodeAt(f++),i=e.charCodeAt(f++),s=n>>2,o=(n&3)<<4|r>>4,u=(r&15)<<2|i>>6,a=i&63,isNaN(r)?u=a=64:isNaN(i)&&(a=64),t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a);return t},decode:function(e){var t="",n,r,i,s,o,u,a,f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length)s=this._keyStr.indexOf(e.charAt(f++)),o=this._keyStr.indexOf(e.charAt(f++)),u=this._keyStr.indexOf(e.charAt(f++)),a=this._keyStr.indexOf(e.charAt(f++)),n=s<<2|o>>4,r=(o&15)<<4|u>>2,i=(u&3)<<6|a,t+=String.fromCharCode(n),u!=64&&(t+=String.fromCharCode(r)),a!=64&&(t+=String.fromCharCode(i));return t=window.Base64._utf8_decode(t),t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t},_utf8_decode:function(e){var t="",n=0,r=0,i=0,s=0;while(n<e.length){r=e.charCodeAt(n);if(r<128)t+=String.fromCharCode(r),n++;else if(r>191&&r<224)s=e.charCodeAt(n+1),t+=String.fromCharCode((r&31)<<6|s&63),n+=2;else{s=e.charCodeAt(n+1);var o=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(s&63)<<6|o&63),n+=3}}return t}}}(window.jQuery),!function(e,t){"use strict";t.ui.texts={};var n=t.ui.texts;n.locale=null,n._dict={},n._pluginTextsLoaded=[],n.load=function(t){var r=e.Deferred();return n.locale?r.resolve():n._load("localization/texts_"+(t||"en")+".json",r)},n.clear=function(){n.locale=null,n._dict={},n._pluginTextsLoaded=[]},n.loadPlugin=function(r){return n._pluginTextsLoaded.indexOf(r)>=0?e.Deferred().resolve():n._load(t.plugins.getLocalizationUrl(r),e.Deferred()).done(function(){n._pluginTextsLoaded.push(r)})},n._load=function(r,i){var s=t.resourceUrl(r);return s?(e.ajax({type:"GET",dataType:"text",url:s}).done(function(e){if(!e||typeof e!="string"){i.reject();return}var r=!1;try{r=JSON.parse(e)}catch(o){(new t.ui.FullErrorView("<b>Localization file syntax error</b> (<code>"+s+"</code>)","<code>"+o.message+"</code>")).show();return}if(!n.locale)n.locale=r.locale;else if(n.locale!=r.locale){i.reject();return}n.add(r.locale,r.texts),i.resolve(r.locale)}).fail(function(e){if(e.status==404){(new t.ui.FullErrorView("Localization file missing: <code>"+s+"</code>",'Either create the file or use <a href="https://code.google.com/p/mollify/wiki/ClientResourceMap">client resource map</a> to load it from different location, or to ignore it')).show();return}i.reject()}),i):i.resolve()},n.add=function(e,t){if(!e||!t)return;if(!n.locale)n.locale=e;else if(e!=n.locale)return;for(var r in t)n._dict[r]=t[r]},n.get=function(e,t){if(!e)return"";var r=n._dict[e];if(!r)return"!"+n.locale+":"+e;if(t){window.isArray(t)||(t=[t]);for(var i=0,s=t.length;i<s;i++)r=r.replace("{"+i+"}",t[i])}return r},n.has=function(e){return!!n._dict[e]},t.ui.formatters={ByteSize:function(e){this.format=function(n){if(!window.def(n))return"";var r=n;if(typeof n=="string"){r=parseInt(r,10);if(isNaN(r))return""}else if(typeof n!="number")return"";if(r<1024)return r==1?t.ui.texts.get("sizeOneByte"):t.ui.texts.get("sizeInBytes",e.format(r));if(r<1048576){var i=r/1024;return i==1?t.ui.texts.get("sizeOneKilobyte"):t.ui.texts.get("sizeInKilobytes",e.format(i))}if(r<1073741824){var s=r/1048576;return t.ui.texts.get("sizeInMegabytes",e.format(s))}var o=r/1073741824;return t.ui.texts.get("sizeInGigabytes",e.format(o))}},Timestamp:function(e){this.format=function(n){return n==null?"":(typeof n=="string"&&(n=t.helpers.parseInternalTime(n)),n.toString(e))}},Number:function(e,t,n){this.format=function(r){if(!window.def(r)||typeof r!="number")return"";var i=Math.pow(10,e),s=Math.floor(r*i)/i,o=s.toString();return n&&(o=o.replace(".",n)),t?o+" "+t:o}}},t.ui.uploader=!1,t.ui.draganddrop=!1,t.ui._activePopup=!1,t.ui.initialize=function(){var n=[];n.push(t.ui.initializeLang()),e("body").append('<div style="width: 0px; height: 0px; overflow: hidden;"><iframe id="mollify-download-frame" src=""></iframe></div>'),e(window).click(function(n){if(t.ui._activePopup){if(n&&n.toElement&&t.ui._activePopup.element){var r=t.ui._activePopup.element();if(r.has(e(n.toElement)).length>0)return}t.ui.hideActivePopup()}}),n.push(t.templates.load("dialogs.html")),t.ui.draganddrop||(t.ui.draganddrop=window.Modernizr.draganddrop?new t.MollifyHTML5DragAndDrop:new t.MollifyJQueryDragAndDrop),t.ui.uploader||(t.ui.uploader=new t.MollifyHTML5Uploader),t.ui.clipboard||new t.ZeroClipboard(function(e){t.ui.clipboard=e});var r=e.Deferred();return e.when.apply(e,n).done(r.resolve).fail(r.reject),r},t.ui.initializeLang=function(){var n=e.Deferred(),r=t.session.lang||t.settings.language["default"]||"en";if(t.ui.texts.locale&&t.ui.texts.locale==r)return n.resolve();var i=t.ui.texts._pluginTextsLoaded;t.ui.texts.locale&&(t.App.getElement().removeClass("lang-"+t.ui.texts.locale),t.ui.texts.clear());var s=[];return s.push(t.ui.texts.load(r).done(function(n){e("html").attr("lang",n),t.App.getElement().addClass("lang-"+n)})),i&&e.each(i,function(e,n){s.push(t.ui.texts.loadPlugin(n))}),e.when.apply(e,s).done(n.resolve).fail(n.reject),n},t.ui.hideActivePopup=function(){t.ui._activePopup&&t.ui._activePopup.hide(),t.ui._activePopup=!1},t.ui.activePopup=function(e){if(e===undefined)return t.ui._activePopup;if(t.ui._activePopup){if(e.parentPopupId&&t.ui._activePopup.id==e.parentPopupId)return;t.ui._activePopup.hide()}return t.ui._activePopup=e,t.ui._activePopup.id||(t.ui._activePopup.id=(new Date).getTime()),t.ui._activePopup.id},t.ui.isActivePopup=function(e){return t.ui._activePopup&&t.ui._activePopup.id==e},t.ui.removeActivePopup=function(e){if(!e||!t.ui.isActivePopup(e))return;t.ui._activePopup=!1},t.ui.download=function(n){t.App.mobile?window.open(n):e("#mollify-download-frame").attr("src",n)},t.ui.itemContext=function(n){var r={};return r._activeItemContext=!1,r.open=function(n){var i=n.item,s=n.element,o=n.viewport,u=n.container,a=n.folder,f="mainview-itemcontext-"+i.id;if(t.ui.isActivePopup(f))return;var l=!1;r._activeItemContext&&(l=r._activeItemContext.item.id,r._activeItemContext.close(),r._activeItemContext=!1);if(i.id==l)return;var c=u||s.parent(),h=t.dom.template("mollify-tmpl-main-itemcontext",i,{})[0].outerHTML;s.popover({title:i.name,html:!0,placement:"bottom",trigger:"manual",template:'<div class="popover mollify-itemcontext-popover"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>',content:h,container:c}).bind("shown",function(a){var l={id:f,hide:function(){s.popover("destroy")}};l.close=l.hide,t.ui.activePopup(l);var h=e("#mollify-itemcontext-"+i.id),p=h.closest(".popover"),d=o.outerWidth(),v=p.offset().left-c.offset().left,m=p.outerWidth();v<0?v=0:v+m>d&&(v=d-m-10),p.css("left",v+"px");var g=s.offset().left-c.offset().left+s.outerWidth()/2;g=Math.max(0,g-v),p.find(".arrow").css("left",g+"px"),p.find(".popover-title").append(e('<button type="button" class="close">×</button>').click(l.close));var y=h.find(".mollify-itemcontext-content");t.filesystem.itemDetails(i,t.plugins.getItemContextRequestData(i)).done(function(e){if(!e){u.hide();return}var t={details:e,folder:n.folder,folder_permission:n.folder_permission};r.renderItemContext(l,y,i,t)})}).bind("hidden",function(){s.unbind("shown").unbind("hidden"),t.ui.removeActivePopup(f)}),s.popover("show")},r.renderItemContext=function(n,r,i,s){var o=t.features.hasFeature("descriptions")&&t.session.admin,u=o||!!s.details.description,a=t.plugins.getItemContextPlugins(i,s),f=t.helpers.getPluginActions(a),l=t.helpers.getPrimaryActions(f),c=t.helpers.getSecondaryActions(f),h={item:i,details:s.details,showDescription:u,description:s.details.description||"",session:t.session,plugins:a,primaryActions:l};r.removeClass("loading").empty().append(t.dom.template("mollify-tmpl-main-itemcontext-content",h,{title:function(e){var n=e;return n.type=="submenu"&&(n=n.primary),n.title?n.title:t.ui.texts.get(n["title-key"])}})),r.click(function(e){return e.preventDefault(),!1}),t.ui.process(r,["localize"]),o&&t.ui.controls.editableLabel({element:e("#mollify-itemcontext-description"),hint:t.ui.texts.get("itemcontextDescriptionHint"),onedit:function(e){t.service.put("filesystem/"+i.id+"/description/",{description:e})}});if(l){var p=r.find(".mollify-itemcontext-primary-action-button");p.each(function(e,r){var i=l[e];i.type=="submenu"&&t.ui.controls.dropdown({element:r,items:i.items,hideDelay:0,style:"submenu",parentPopupId:n.id,onItem:function(){n.hide()},onBlur:function(e){e.hide()}})}),p.click(function(t){var r=p.index(e(this)),i=l[r];if(i.type=="submenu")return;n.close(),i.callback()})}if(a){var d=e("#mollify-itemcontext-details-selectors"),v=e("#mollify-itemcontext-details-content"),m={},g=function(t){e(".mollify-itemcontext-details-selector").removeClass("active"),e("#mollify-itemcontext-details-selector-"+t).addClass("active"),v.find(".mollify-itemcontext-plugin-content").hide();var r=m[t]?m[t]:!1;r||(r=e('<div class="mollify-itemcontext-plugin-content"></div>'),a[t].details["on-render"](n,r),m[t]=r,v.append(r)),r.show()},y=!1,b=function(){var t=e(this).tmplItem().data;g(t.id)};for(var w in a){var E=a[w];if(!E.details)continue;y||(y=w);var S=E.details.title?E.details.title:E.details["title-key"]?t.ui.texts.get(E.details["title-key"]):w,x=t.dom.template("mollify-tmpl-main-itemcontext-details-selector",{id:w,title:S,data:E}).appendTo(d).click(b)}y&&g(y)}t.ui.controls.dropdown({element:r.find("#mollify-itemcontext-secondary-actions"),items:c,hideDelay:0,style:"submenu",parentPopupId:n.id,onItem:function(){n.hide()},onBlur:function(e){e.hide()}})},{open:r.open}},t.ui.assign=function(e,t,n){if(!e||!t||!n)return;e.controls||(e.controls={}),e.controls[t]=n},t.ui.process=function(n,r,i){e.each(r,function(e,r){t.ui.handlers[r]&&t.ui.handlers[r](n,i)})},t.ui.handlers={localize:function(n,r){n.find(".localized").each(function(){var n=e(this),r=n.attr("title-key");r&&(n.attr("title",t.ui.texts.get(r)),n.removeAttr("title-key")),r=n.attr("text-key"),r&&(n.prepend(t.ui.texts.get(r)),n.removeAttr("text-key"))}),n.find("input.hintbox").each(function(){var n=e(this),r=t.ui.texts.get(n.attr("hint-key"));n.attr("placeholder",r).removeAttr("hint-key")})},center:function(t,n){t.find(".center").each(function(){var t=e(this),n=(t.parent().width()-t.outerWidth(!0))/2;t.css({position:"relative",left:n})})},hover:function(t){t.find(".hoverable").hover(function(){e(this).addClass("hover")},function(){e(this).removeClass("hover")})},bubble:function(n,r){n.find(".bubble-trigger").each(function(){var n=e(this),i=t.ui.controls.bubble({element:n,handler:r});t.ui.assign(r,n.attr("id"),i)})},radio:function(n,r){n.find(".mollify-radio").each(function(){var n=e(this),i=t.ui.controls.radio(n,r);t.ui.assign(r,n.attr("id"),i)})}},t.ui.window={open:function(e){window.open(e)}},t.ui.preloadImages=function(t){e.each(t,function(){e("<img/>")[0].src=this})},t.ui.FullErrorView=function(e,n){this.show=function(){this.init(t.App.getElement())},this.init=function(r){if(t.App._initialized)t.dom.template("mollify-tmpl-fullpage-error",{title:e,message:n}).appendTo(r.empty());else{var i="<h1>"+e+"</h1><p>"+n+"</p>";r.html(i)}}};var r=function(n){e.each(n,function(e,n){if(n.type=="submenu"){r(n.items);return}if(n.title)return;n["title-key"]&&(n.title=t.ui.texts.get(n["title-key"]))})},i=function(e){var n=e||[];return r(n),t.dom.template("mollify-tmpl-popupmenu",{items:n})},s=function(t,n,r){t.find(".dropdown-item").click(function(){var i=e(this),s=t.find(".dropdown-menu"),o=[];for(;;){i.hasClass("dropdown-menu")||o.push(i.index()),i=i.parent();if(i[0]==s[0])break}var u=!1,a=n;return e.each(o.reverse(),function(e,t){u=a[t],u.type=="submenu"&&(a=u.items)}),r?r(u,u.callback?u.callback():null):u.callback&&u.callback(),!1})};t.ui.controls={dropdown:function(n){var r=e(n.element),o=!1,u=!1,a=n.items,f=function(){if(!o)return;n.onHide&&n.onHide(),o.parent().removeClass("open"),t.ui.removeActivePopup(u)},l=function(e,t){f(),n.onItem&&n.onItem(e,t)},c={hide:f,items:function(e){o.remove(),o=i(e),r.removeClass("loading").append(o),s(r,e,l),a=e}};n.parentPopupId&&(c.parentPopupId=n.parentPopupId);var h=r.find(".dropdown-toggle"
);if(h.length!=1)return;h.parent().append(i(n.items)),h.dropdown({onshow:function(r){o||(o=e(r.find(".dropdown-menu")[0])),n.parentPopupId||(u=t.ui.activePopup(c)),a||o.addClass("loading"),n.onShow&&n.onShow(c,a)},onhide:function(){f(),n.dynamic&&(a=!1)}}),s(r,n.items,l)},popupmenu:function(n){var r=!1,o=e(n.element),u=o.offset(),a=e('<div class="mollify-popupmenu" style="position: absolute; top: '+(u.top+o.outerHeight())+"px; left:"+u.left+'px;"></div>'),f=n.items,l=function(){n.onHide&&n.onHide(),a.remove(),t.ui.removeActivePopup(r)},c=function(e,t){l(),n.onItem&&n.onItem(e,t)};n.items||a.addClass("loading"),a.append(i(n.items).css("display","block")),n.style&&a.addClass(n.style),t.App.getElement().append(a);var h={hide:l,items:function(e){a.empty().removeClass("loading").append(i(e).css("display","block")),s(a,e,c)}};return n.items&&s(a,n.items,c),r=t.ui.activePopup(h),h},bubble:function(n){var r=n.element,i=r.attr("id");if(!i)return;var s=e("#"+i+"-bubble");if(!s||s.length===0)return;var o=s.html();s.remove();var u=!1,a=!1,f={hide:function(){r.popover("hide")},close:this.hide},l=e('<div class="popover mollify-bubble-popover"><div class="arrow"></div><div class="popover-inner"><div class="popover-content"><p></p></div></div></div>');r.popover({title:!1,html:!0,placement:"bottom",trigger:"manual",template:l,content:o}).bind("shown",function(e){u=l,t.ui.activePopup(f),a||(n.handler&&n.handler.onRenderBubble&&n.handler.onRenderBubble(i,f),a=!0),n.handler&&n.handler.onShowBubble&&n.handler.onShowBubble(i,f)}).bind("hidden",function(){t.ui.removeActivePopup(f.id)}),r.click(function(e){return e.preventDefault(),r.popover("show"),!1})},dynamicBubble:function(n){var r=n.element,i=function(t){return t?typeof t=="string"?t:e("<div/>").append(t).html():""},s=n.content?i(n.content):'<div class="loading"></div>',o=!1,u=n.container||r.parent(),a=n.viewport||u,f=function(){var e=c.closest(".popover"),t=a.outerWidth(),n=e.offset().left-u.offset().left,i=e.outerWidth();n<0?n=0:n+i>t&&(n=t-i-10),e.css("left",n+"px");var s=r.offset().left-u.offset().left+r.outerWidth()/2-10;s=Math.max(0,s-n),e.find(".arrow").css("left",s+"px")},l={show:function(){r.popover("show")},hide:function(e){e?o.hide():r.popover("destroy")},element:function(){return o},getContent:function(){return o.find(".popover-content")},content:function(e){var t=o.find(".popover-content");typeof e=="string"?t.html(e):t.empty().append(e),f()},position:f};l.close=l.hide;var c=e('<div class="popover mollify-bubble-popover"><div class="arrow"></div>'+(n.title?'<h3 class="popover-title"></h3>':"")+'<div class="popover-content"></div></div>');return r.popover({title:n.title?n.title:!1,html:!0,placement:"bottom",trigger:"manual",template:c,content:s,container:u}).bind("shown",function(r){o=c,t.ui.activePopup(l),o.click(function(e){e.stopPropagation()}),n.title&&o.find(".popover-title").append(e('<button type="button" class="close">×</button>').click(function(){l.close()})),t.ui.handlers.localize(o),n.handler&&n.handler.onRenderBubble&&n.handler.onRenderBubble(l)}).bind("hidden",function(){r.unbind("shown").unbind("hidden"),t.ui.removeActivePopup(l.id)}),r.popover("show"),l},table:function(n,r){var i=typeof n=="string"?e("#"+n):e(n);if(i.length===0||!r.columns)return!1;var s=e.Callbacks();i.addClass("mollify-table"),r.id&&i.addClass("mollify-table-"+r.id),r.onSelectionChanged&&s.add(r.onSelectionChanged),i.addClass("table"),r.narrow&&i.addClass("table-condensed"),r.hilight&&i.addClass("hilight");var o=!1,u=!1,a=r.remote&&r.remote.paging?r.remote.paging.max||50:50,f=function(){var t=u.find("ul").empty(),n=o?Math.ceil(o.total/a):0;if(n<2)return;var r=o?Math.floor(o.start/a)+1:0,i=r+Math.floor((n-r)/2),s=function(t){return e('<li class="page-btn page-nr'+(r==t?" active":"")+'"><a href="javascript:void(0);">'+t+"</a></li>")};t.append(e('<li class="page-btn page-prev'+(r<=1?" disabled":"")+'"><a href="javascript:void(0);">&laquo;</a></li>'));if(n<=10)for(var f=1;f<=n;f++)t.append(s(f));else r!=1&&t.append(s(1)),r>2&&t.append(s(2)),r>3&&t.append("<li class='page-break'>...</li>"),r>4&&t.append(s(r-2)),r>3&&t.append(s(r-1)),t.append(s(r)),r<n-2&&t.append(s(r+1)),r<n-1&&t.append(s(r+2)),r<n-2&&t.append("<li class='page-break'>...</li>"),r<n-1&&t.append(s(n-1)),r!=n&&t.append(s(n));t.append(e('<li class="page-btn page-next'+(r>=n?" disabled":"")+'"><a href="javascript:void(0);">&raquo;</a></li>'))};if(r.remote&&r.remote.paging){var l=r.remote.paging.controls||e("<div class='mollify-table-pager'></div>").insertAfter(i);u=e('<div class="pagination"><ul></ul></div>').appendTo(l),l.delegate(".page-btn > a","click",function(t){if(!o)return;var n=e(this),r=n.parent();if(r.hasClass("disabled"))return;var i=Math.floor(o.start/a)+1,s=Math.ceil(o.total/a);r.hasClass("page-next")?i++:r.hasClass("page-prev")?i--:i=parseInt(n.text(),10);if(i<1||i>s)return;o.start=(i-1)*a,M.refresh()}),f()}var c=function(t){var n=!1;return N.find("tr").each(function(){var r=e(this),i=r[0].data;if(t==i)return n=r,!1}),n},h=function(){var t=[];return i.find(".mollify-tableselect:checked").each(function(n,r){var i=e(r).parent().parent()[0].data;t.push(i)}),t},p=function(e,t){var n=c(e);n.find(".mollify-tableselect").prop("checked",t),s.fire()},d=function(){var e=N.children().length,t=e>0&&h().length==e;t?i.find(".mollify-tableselect-header").prop("checked",!0):i.find(".mollify-tableselect-header").prop("checked",!1)};s.add(d);var v=function(e){i.find(".mollify-tableselect").prop("checked",e)},m=e("<tr></tr>").appendTo(e("<thead></thead>").appendTo(i)),g=!1,y=function(e){var t=N.children().length,n=t>0&&h().length==t;v(!n),s.fire()};for(var b=0,w=r.columns.length;b<w;b++){var E,S=r.columns[b];S.type=="selectrow"?E=e('<input class="mollify-tableselect-header" type="checkbox"></input>').click(y):(E=e("<th>"+(S.type=="action"?"":S.title?S.title:"")+"</th>"),E[0].colId=S.id,S.sortable&&(E.append("<span class='mollify-tableheader-sort'></span>").addClass("sortable"),g||(g=S.id))),S.id&&E.addClass("col-"+S.id),E.appendTo(m)}var x=!1;g&&(x={id:g,asc:!0}),r.defaultSort&&(x=r.defaultSort);var T=function(){i.find("th.sortable > .mollify-tableheader-sort").empty();if(!x)return;var t=e("th.col-"+x.id+" > .mollify-tableheader-sort");t.html("<i class='"+(x.asc?"icon-caret-up":"icon-caret-down")+"'></i>")};i.delegate("th.sortable","click",function(t){var n=e(this),r=n[0].colId;x&&x.id==r?x.asc=!x.asc:x={id:r,asc:!0},T(),M.refresh()}),T();var N=e("<tbody></tbody>").appendTo(i),C=!1;r.emptyHint&&(C=e("<tr class='mollify-table-empty-hint'><td colspan='"+r.columns.length+"'>"+r.emptyHint+"</td></tr>")),i.delegate(".mollify-tableselect","change",function(e){return s.fire(),!1}),i.delegate("a.mollify-tableaction","click",function(t){var n=e(this).parent(),i=n.parent(),s=n[0].colId,o=i[0].data;return t.stopPropagation(),r.onRowAction&&r.onRowAction(s,o),!1}),r.hilight&&i.delegate("tr","click",function(t){if(t.target&&e(t.target).hasClass("mollify-tableselect"))return;var n=e(this),o=n[0].data;if(!o)return;n.hasClass("info")?(n.removeClass("info"),n.find(".mollify-tableselect").prop("checked",!1),o=null):(i.find("tr").removeClass("info"),v(!1),n.find(".mollify-tableselect").prop("checked",!0),n.addClass("info")),s.fire(),r.onHilight&&r.onHilight(o)});var k=function(n,i,s){n[0].colId=i.id;var o=s[i.id];i.cellClass&&n.addClass(i.cellClass);if(i.type=="selectrow")var u=e('<input class="mollify-tableselect" type="checkbox"></input>').appendTo(n);else if(i.type=="action"){var a=i.content;i.valueMapper&&(a=i.valueMapper(s,o)),a&&e("<a class='mollify-tableaction' title='"+i.title+"'></a>").html(a).appendTo(n)}else if(i.type=="input"){var f=e('<input type="text"></input>').appendTo(n).change(function(){var e=f.val();n[0].ctrlVal=e,r.selectOnEdit&&p(s,!0),i.onChange&&i.onChange(s,e)});n[0].ctrl=f;var l=o;i.valueMapper&&(l=i.valueMapper(s,o)),f.val(l)}else if(i.type=="select"){var c=t.ui.controls.select(e("<select></select>").appendTo(n),{values:i.options,title:"title",onChange:function(e){n[0].ctrlVal=e,r.selectOnEdit&&p(s,!0),i.onChange&&i.onChange(s,e)}});n[0].ctrl=c;var h=o;i.valueMapper&&(h=i.valueMapper(s,o)),c.select(h)}else i.type=="static"?n.html(i.content||""):i.renderer?i.renderer(s,o,n):i.valueMapper?n.html(i.valueMapper(s,o)):i.formatter?n.html(i.formatter.format(o)):n.html(o)},L=function(t){C&&C.detach();var n=e("<tr></tr>").appendTo(N);n[0].data=t,r.onRow&&r.onRow(n,t);for(var i=0,s=r.columns.length;i<s;i++){var o=e("<td></td>").appendTo(n);k(o,r.columns[i],t)}},A=function(t){t.find("td").each(function(){var n=e(this),i=n.index();k(n,r.columns[i],t[0].data)})},O=function(){if(!C)return;var e=N.find("tr").length;e===0?C.appendTo(N):C.hide()},M={findByKey:function(t){if(!r.key)return!1;var n=!1;return N.find("tr").each(function(){var i=e(this)[0].data;if(i[r.key]==t)return n=i,!1}),n},onSelectionChanged:function(e){s.add(e)},getSelected:function(){return h()},getValues:function(){var t={};return N.find("td").each(function(){var n=e(this),i=n[0].ctrlVal;if(!i)return;var s=n.parent(),o=s[0].data,u=o[r.key];t[u]||(t[u]={}),t[u][n[0].colId]=i}),t},set:function(t){C&&C.detach(),N.empty(),e.each(t,function(e,t){L(t)}),O(),s.fire()},add:function(e){if(!e)return;if(window.isArray(e))for(var t=0,n=e.length;t<n;t++)L(e[t]);else L(e);O()},update:function(e){if(!e)return;var t=c(e);if(!t)return;A(t)},remove:function(e){if(!e)return;var t=c(e);if(!t)return;t.remove(),O()},refresh:function(){var n=e.Deferred();if(!r.remote||!r.remote.path)return n.resolve();var i={count:a,start:o?o.start:0,sort:x};if(r.remote.queryParams){var s=r.remote.queryParams(o);s&&(i=e.extend(i,s))}var u=t.service.post(r.remote.path,i).done(function(e){r.remote.paging?(o={start:e.start,count:e.count,total:e.total},f()):o=!1,M.set(e.data),n.resolve()}).fail(n.reject);return r.remote.onLoad&&r.remote.onLoad(u),n}};return M},select:function(t,n){var r=typeof t=="string"?e("#"+t):t;if(!r||r.length===0)return!1;var i=function(t){var i=e("<option></option>").appendTo(r);if(t==n.none)i.html(t);else if(n.renderer)n.renderer(t,i);else{var s;typeof t=="string"||!n.title?(s=t,n.valueMapper&&(s=n.valueMapper(t))):s=t[n.title],i.html(s)}i[0].data=t},s=function(){var e=r.find("option:selected");if(!e||e.length===0)return null;var t=e[0].data;return t==n.none?null:t};n.onChange&&r.change(function(){n.onChange(s())});var o={add:function(e){if(!e)return;if(window.isArray(e))for(var t=0,n=e.length;t<n;t++)i(e[t]);else i(e)},select:function(t){var i=r.find("option");if(typeof t=="number"){if(i.length>=t)return;e(i[t]).prop("selected",!0);return}var s=t;n.none&&!s&&(s=n.none);for(var o=0,u=i.length;o<u;o++)if(i[o].data==s){e(i[o]).prop("selected",!0);return}},get:s,set:this.select,selected:s};return n.none&&o.add(n.none),n.values&&o.add(n.values),o},radio:function(t,n){var r=t.addClass("btn-group").attr("id"),i=t.find("button"),s=function(e){i.removeClass("active"),e.addClass("active")};return i.click(function(){var t=e(this),o=i.index(t);s(t);var u=t.attr("id");n&&r&&n.onRadioChanged&&n.onRadioChanged(r,u,o)}),{set:function(t){s(e(i[t]))}}},datepicker:function(n,r){if(!n)return!1;r||(r={});var i=typeof n=="string"?e("#"+n):n;e.fn.datetimepicker.dates.mollify||(e.fn.datetimepicker.dates.mollify={days:t.ui.texts.get("days"),daysShort:t.ui.texts.get("daysShort"),daysMin:t.ui.texts.get("daysMin"),months:t.ui.texts.get("months"),monthsShort:t.ui.texts.get("monthsShort"),today:t.ui.texts.get("today"),weekStart:t.ui.texts.get("weekStart")});var s=r.value||null,o=r.format||t.ui.texts.get("shortDateTimeFormat");o=o.replace(/\b[h]\b/,"hh"),o=o.replace(/\b[M]\b/,"MM"),o=o.replace(/\b[d]\b/,"dd"),o=o.replace("tt","PP");var u=i.datetimepicker({format:o,language:"mollify",pickTime:r.time||!0,pickSeconds:o.indexOf("s")>=0}).on("changeDate",function(e){s=e.date}),a=u.data("datetimepicker");s&&a.setDate(s);var f={get:function(){return s?new Date(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds()):s},set:function(e){s=e!=null?new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds())):null,a.setDate(s)}};return u.data("mollify-datepicker",f),f},editableLabel:function(t){var n=e(t.element),r=n.attr("id"),i=t.value||n.html().trim();if(!r)return;n.addClass("editable-label").hover(function(){n.addClass("hover")},function(){n.removeClass("hover")});var s=e("<label></label>").appendTo(n.empty()),o=e("<input></input>").appendTo(n),u={value:function(e){i=e,i||!t.hint?(n.removeClass("hint"),s.html(i)):(n.addClass("hint"),s.html(t.hint)),o.val(i)}};u.value(i);var a=function(){var e=o.val();if(t.isvalid&&!t.isvalid(e))return;o.hide(),s.show(),i!=e&&(t.onedit&&t.onedit(e),u.value(e))},f=function(){o.hide(),s.show(),u.value(i)};return o.hide().bind("blur",a).keyup(function(e){e.which==13?a():e.which==27&&f()}),s.bind("click",function(){s.hide(),o.show().focus()}),u},slidePanel:function(n,r){if(!n)return;var i=t.dom.template("mollify-tmpl-slidepanel").appendTo(n);r.relative&&i.addClass("relative");var s=i.find(".mollify-slidepanel-content");r.resizable&&i.resizable({handles:"n"}).bind("resize",function(t,n){e(this).css("top","auto")});var o={getContentElement:function(){return s},show:function(e,t){e&&s.empty().append(e),s.parent().scrollTop(0),i.animate({height:t+"px"},500)},hide:function(){i.animate({height:"0px"},500)},remove:function(){i.remove()}};return i.find(".close").click(o.hide),o}},t.ui.dialogs={};var o=t.ui.dialogs;o._dialogDefaults={title:"Mollify"},o.closeActiveDialog=function(){if(!o._activeDialog)return;o._activeDialog.close()},o.info=function(t){o.custom({title:t.title,content:e("#mollify-tmpl-dialog-info").tmpl({message:t.message}),buttons:[{id:"ok","title-key":"ok",cls:"btn-primary"}],"on-button":function(e,n){n.close(),t.callback&&t.callback()}})},o.showActionDeniedMessage=function(e,n){var r="<p>"+e+"</p><p><ul>";for(var i=0,s=n.length;i<s;i++)r=r+"<li>"+n[i]+"</li>";r+="</ul></p>",t.ui.dialogs.error({title:t.ui.texts.get("errorDialogTitle"),message:r})},o.confirmActionAccept=function(e,n,r,i){var s="<p>"+e+"</p><p><ul>";for(var u=0,a=n.length;u<a;u++)s=s+"<li>"+n[u]+"</li>";s+="</ul></p>",o.custom({title:t.ui.texts.get("errorDialogTitle"),content:s,buttons:[{id:"yes","title-key":"yes",cls:"btn-primary"},{id:"no","title-key":"no"}],"on-button":function(e,t){t.close(),e.id==="yes"&&(r?r():i&&i())}})},o.showError=function(n){var r="errorDialogMessage_"+n.code;t.ui.texts.has(r)||(r="errorDialogUnknownError"),t.session.admin&&n.trace?o.custom({title:t.ui.texts.get("errorDialogTitle"),content:e("#mollify-tmpl-dialog-error-debug").tmpl({title:t.ui.texts.get("errorDialogTitle"),message:t.ui.texts.get(r),debug:n.trace.join("<br/>")}),buttons:[{id:"ok","title-key":"ok",cls:"btn-primary"}],"on-button":function(e,t){t.close()}}):t.ui.dialogs.error({title:t.ui.texts.get("errorDialogTitle"),message:t.ui.texts.get(r)})},o.select=function(n){var r=!1;o.custom({title:n.title,initSize:n.initSize,content:e("#mollify-tmpl-dialog-select").tmpl({message:n.message}),buttons:[{id:"ok","title-key":"ok",cls:"btn-primary"},{id:"cancel","title-key":"dialogCancel"}],"on-button":function(e,t){var i;if(e.id=="ok"){i=r.getSelected();if(!i||i.length===0)return}t.close(),e.id=="ok"&&n.onSelect&&n.onSelect(i,r.getValues())},"on-show":function(i,s){var o=e(s.find(".mollify-selectdialog-table")[0]);r=t.ui.controls.table(o,{key:n.key,selectOnEdit:!0,columns:[{type:"selectrow"}].concat(n.columns)}),r.set(n.list)}})},o.error=function(t){o.custom({title:t.title,content:e("#mollify-tmpl-dialog-error").tmpl({message:t.message}),buttons:[{id:"ok","title-key":"ok",cls:"btn-primary"}],"on-button":function(e,n){n.close(),t.callback&&t.callback()}})},o.confirmation=function(e){o.custom({title:e.title,content:e.message,buttons:[{id:"yes","title-key":"yes"},{id:"no","title-key":"no"}],"on-button":function(t,n){n.close(),e.callback&&t.id==="yes"&&e.callback()}})},o.input=function(t){var n=!1;o.custom({title:t.title,content:e("#mollify-tmpl-dialog-input").tmpl({message:t.message}),buttons:[{id:"yes",title:t.yesTitle,cls:"btn-primary"},{id:"no",title:t.noTitle}],"on-button":function(e,r){if(e.id==="yes"){if(!t.handler||!t.handler.isAcceptable)return;if(!t.handler.isAcceptable(n.val()))return}r.close(),e.id==="yes"&&t.handler.onInput(n.val())},"on-show":function(e,r){n=r.find(".mollify-inputdialog-input"),t.defaultValue&&n.val(t.defaultValue),n.focus()}})},o.wait=function(n){var r=n&&n.target?e("#"+n.target):e("body"),i=t.dom.template("mollify-tmpl-wait",e.extend(n,o._dialogDefaults)).appendTo(r).show();return{close:function(){i.remove()}}},o.notification=function(n){if(t.App.activeView&&t.App.activeView.onNotification&&t.App.activeView.onNotification(n))return;var r=n&&n.target?typeof n.target=="string"?e("#"+n.target):n.target:e("#mollify-notification-container");r.length===0&&(r=e("body"));var i=t.dom.template("mollify-tmpl-notification",e.extend(n,o._dialogDefaults)).hide().appendTo(r).fadeIn(300);setTimeout(function(){i.fadeOut(300),n["on-finish"]&&n["on-finish"]()},n.time|3e3)},o.custom=function(n){var r=function(e){e.css("margin-left",-e.outerWidth()/2),e.css("margin-top",-e.outerHeight()/2),e.css("top","50%"),e.css("left","50%")},i=n;i["title-key"]&&(i.title=t.ui.texts.get(i["title-key"]));var s=e("#mollify-tmpl-dialog-custom").tmpl(e.extend(o._dialogDefaults,i),{getContent:function(){if(n.html)return n.html;if(n.content){var t=n.content;return typeof t=="string"?t:e("<div/>").append(t.clone()).html()}return""},getButtonTitle:function(e){return e.title?e.title:e["title-key"]?t.ui.texts.get(e["title-key"]):""}});n.element&&s.find(".modal-body").append(n.element),t.ui.handlers.localize(s),s.on("hidden",function(e){if(e.target!=s[0])return;s.remove()}).modal({backdrop:"static",show:!0,keyboard:!0});var u={close:function(){s.modal("hide"),o._activeDialog=!1},center:function(){r(s)}};s.find(".modal-footer .btn").click(function(t){t.preventDefault();var r=e(this).tmplItem().data,i=r.buttons[e(this).index()];n["on-button"]&&n["on-button"](i,u)});if(n.resizable){var a=s.find(".modal-header"),f=s.find(".modal-body"),l=s.find(".modal-footer"),c=30;f.css({"max-height":"none","max-width":"none"});var h=function(){r(s);var e=s.innerHeight()-a.outerHeight()-l.outerHeight()-c;f.css("height",e)};s.css({"max-height":"none","max-width":"none","min-height":s.outerHeight()+"px","min-width":s.outerWidth()+"px"}).on("resize",h).resizable(),n.initSize&&s.css({width:n.initSize[0]+"px",height:n.initSize[1]+"px"}),h()}return n["on-show"]&&n["on-show"](u,s),o._activeDialog=u,u},o.folderSelector=function(n){var r=!1,i=e("#mollify-tmpl-dialog-folderselector").tmpl({message:n.message}),s=!1,u={},a=function(n,r){if(u[r?r.id:"root"])return;s.addClass("loading"),t.filesystem.folders(r).done(function(t){s.removeClass("loading"),u[r?r.id:"root"]=!0;if(!t||t.length===0){n&&n.find(".mollify-folderselector-folder-indicator").empty();return}var i=0,o=[];if(r){var f=r.path.match(/\//g);f?i=f.length+1:i=1;for(var l=0;l<i;l++)o.push({})}var c=e("#mollify-tmpl-dialog-folderselector-folder").tmpl(t,{cls:i===0?"root":"",levels:o});n?(n.after(c),n.addClass("loaded"),n&&n.find(".mollify-folderselector-folder-indicator").find("i").removeClass("icon-caret-right").addClass("icon-caret-down")):s.append(c),!r&&t.length==1&&a(e(c[0]),t[0])})};o.custom({title:n.title,content:i,buttons:[{id:"action",title:n.actionTitle,cls:"btn-primary"},{id:"cancel","title-key":"dialogCancel"}],"on-button":function(e,t){if(e.id==="action")if(!r||!n.handler||!n.handler.canSelect(r))return;t.close(),e.id==="action"&&n.handler.onSelect(r)},"on-show":function(t,i){s=i.find(".mollify-folderselector-tree"),s.on("click",".mollify-folderselector-folder-indicator",function(t){var n=e(this).parent(),r=n.tmplItem().data;return a(n,r),!1}),s.on("click",".mollify-folderselector-folder",function(t){var i=e(this),s=e(this).tmplItem().data;n.handler.canSelect(s)&&(r=s,e(".mollify-folderselector-folder").removeClass("selected"),i.addClass("selected"))}),a(null,null)}})},o.tableView=function(e){t.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:e.title,content:t.dom.template("mollify-tmpl-tableview"),buttons:e.buttons,"on-button":function(t,n){e.onButton(t,n)},"on-show":function(n,r){var i=r.find("#mollify-tableview-content");n.center();var s=t.ui.controls.table("mollify-tableview-list",{key:e.table.key,columns:e.table.columns,onRowAction:function(t,r){e.onTableRowAction&&e.onTableRowAction(n,s,t,r)}});e.onRender(n,i,s)}})},t.MollifyHTML5DragAndDrop=function(){var n=this;n.dragObj=!1,n.dragEl=!1,n.dragListener=!1;var r=function(e){n.dragEl&&(n.dragEl.removeClass("dragged"),n.dragListener&&n.dragListener.onDragEnd&&n.dragListener.onDragEnd(n.dragEl,e),n.dragEl=!1),n.dragObj=!1,n.dragListener=!1};e("body").bind("dragover",function(e){return e.preventDefault&&e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="none",!1}),setTimeout(function(){var e=[];for(var n in t.settings.dnd.dragimages){if(!t.settings.dnd.dragimages.hasOwnProperty(n))continue;var r=t.settings.dnd.dragimages[n];if(!r)continue;if(e.indexOf(r)>=0)continue;e.push(r)}e&&t.ui.preloadImages(e)},0);var i={enableDragToDesktop:function(e,n){if(!e)return;var r=t.getItemDownloadInfo(e);r&&n.originalEvent.dataTransfer.setData("DownloadURL",["application/octet-stream",r.name,r.url].join(":"))},enableDrag:function(s,o){s.attr("draggable","true").bind("dragstart",function(r){n.dragObj=!1,r.originalEvent.dataTransfer.effectAllowed="none";if(!o.onDragStart)return!1;n.dragObj=o.onDragStart(e(this),r);if(!n.dragObj)return!1;var s=n.dragObj.type;if(n.dragObj.type=="filesystemitem"){var u=n.dragObj.payload;if(!window.isArray(u)||u.length==1){var a=window.isArray(u)?u[0]:u;a.is_file?s="filesystemitem-file":s="filesystemitem-folder"}else s="filesystemitem-many";i.enableDragToDesktop(u,r)}n.dragEl=e(this),n.dragListener=o,n.dragEl.addClass("dragged"),r.originalEvent.dataTransfer.effectAllowed="copyMove";if(t.settings.dnd.dragimages[s]){var f=document.createElement("img");f.src=t.settings.dnd.dragimages[s],r.originalEvent.dataTransfer.setDragImage(f,0,0)}return}).bind("dragend",function(e){r(e)})},enableDrop:function(t,i){t.addClass("droppable").bind("drop",function(t){t.stopPropagation&&t.stopPropagation();if(!i.canDrop||!i.onDrop||!n.dragObj)return;var s=e(this);i.canDrop(s,t,n.dragObj)&&(i.onDrop(s,t,n.dragObj),s.removeClass("dragover")),r(t)}).bind("dragenter",function(t){if(!i.canDrop||!n.dragObj)return!1;var r=e(this);i.canDrop(r,t,n.dragObj)&&r.addClass("dragover")}).bind("dragover",function(t){t.preventDefault&&t.preventDefault();var r="none";if(i.canDrop&&i.dropType&&n.dragObj){var s=e(this);if(i.canDrop(s,t,n.dragObj)){var o=i.dropType(s,t,n.dragObj);o&&(r=o)}}return t.originalEvent.dataTransfer.dropEffect=r,!1}).bind("dragleave",function(t){var r=e(this);r.removeClass("dragover"),n.dragTarget=!1})}};return i},t.MollifyJQueryDragAndDrop=function(){return{enableDragToDesktop:function(e,t){},enableDrag:function(t,n){t.draggable({revert:"invalid",distance:10,addClasses:!1,zIndex:2700,start:function(t){n.onDragStart&&n.onDragStart(e(this),t)}})}}},t.ZeroClipboard=function(t){if(!t||!window.ZeroClipboard)return!1;window.ZeroClipboard.setDefaults({moviePath:"js/lib/ZeroClipboard.swf",hoverClass:"hover",activeClass:"active",forceHandCursor:!0});var n=e('<div id="zeroclipboard-test" style="width=0px; height=0px;"></div>').appendTo(e("body")),r=new window.ZeroClipboard(n[0]);r.on("load",function(e){var n={enableCopy:function(e,t,n){var r=e.data("mollify-zeroclipboard");r||(r=new window.ZeroClipboard(e),e.data("mollify-zeroclipboard",r),n&&e.data("mollify-zeroclipboard-listener",n)),t&&e.data("mollify-zeroclipboard-text",t)}};t(n)}),r.on("dataRequested",function(){var t=e(this),n=t.data("mollify-zeroclipboard-listener"),i=!1;n&&n.onGetText&&(i=n.onGetText(t)),i||(i=t.data("mollify-zeroclipboard-text")),i&&r.setText(i)}),r.on("mouseover",function(){var t=e(this),n=t.data("mollify-zeroclipboard-listener");n&&n.onMouseOver&&n.onMouseOver(t,r)}),r.on("mouseout",function(){var t=e(this),n=t.data("mollify-zeroclipboard-listener");n&&n.onMouseOut&&n.onMouseOut(t)}),r.on("complete",function(t,n){var r=e(this),i=r.data("mollify-zeroclipboard-listener");i&&i.onCopy&&i.onCopy(r,n.text)})}}(window.jQuery,window.mollify),!function(e,t){"use strict";t.view.MainView=function(){var n=this;this._mainFileView=!1,this._mainConfigView=!1,this._views=[],this._currentView=!1,this.init=function(r,i){n._mainFileView=new t.view.MainViewFileView,n._mainConfigView=new t.view.MainViewConfigView,n._views=[this._mainFileView,this._mainConfigView],e.each(t.plugins.getMainViewPlugins(),function(e,t){if(!t.mainViewHandler)return;var r=t.mainViewHandler();n._views.push(r)}),n.itemContext=new t.ui.itemContext,t.dom.loadContentInto(r,t.templates.url("mainview.html"),function(){n.onLoad(i)},["localize"])},this.onLoad=function(r){e(window).resize(n.onResize),n.onResize(),t.dom.template("mollify-tmpl-main-username",t.session).appendTo("#mollify-mainview-user"),t.session.authenticated&&t.ui.controls.dropdown({element:e("#mollify-username-dropdown"),items:n.getSessionActions()});var i=[];e.each(n._views,function(e,t){t.init(n),i.push({icon:t.icon,title:t.title})});var s=e("#mollify-mainview-menu"),o=t.dom.template("mollify-tmpl-main-menubar",i).appendTo(s);o.click(function(){var t=o.index(e(this));n.activateView(n._views[t])});if(n._views.length>0){var u=!1;if(r){u=n._findView(r[0]),r=r.slice(1);if(r.length===0||r.length==1&&r[0]==="")r=!1}u||(u=n._views[0],r=!1),n.activateView(u,r)}},this._findView=function(t){var r=!1;return e.each(n._views,function(e,n){if(n.viewId==t)return r=n,!1}),r},this.onRestoreView=function(e){var t=e[0];if(n._currentView&&n._currentView.viewId==t)n._currentView.onRestoreView(e.slice(1));else{var r=n._findView(t);if(r){t=e.slice(1);if(t.length===0||t.length==1&&t[0]==="")t=!1;n.activateView(r,t)}}},this.activateView=function(r,i){t.ui.hideActivePopup(),n._currentView&&n._currentView.onDeactivate&&n._currentView.onDeactivate(),e("#mollify-mainview-navlist-parent").empty(),n._currentView=r,e("#mollify-mainview-navbar").empty(),r.onActivate({id:i,content:e("#mollify-mainview-viewcontent").empty(),tools:e("#mollify-mainview-viewtools").empty(),addNavBar:n.addNavBar,mainview:n,fileview:n._mainFileView});var s=e("#mollify-mainview-menu"),o=s.find(".mollify-mainview-menubar-item").removeClass("active"),u=n._views.indexOf(r);e(o.get(u)).addClass("active")},this.onNotification=function(n){var r=n&&n.target?typeof n.target=="string"?e("#"+n.target):n.target:e("#mollify-mainview-content"),i=t.dom.template("mollify-tmpl-main-notification",n).hide().appendTo(r).fadeIn(300);return setTimeout(function(){i.fadeOut(300),setTimeout(i.remove,300),n["on-finish"]&&n["on-finish"]()},n.time|3e3),!0},this.getActiveView=function(){return n._currentView},this.addNavBar=function(n){var r=t.dom.template("mollify-tmpl-main-navbar",n).appendTo(e("#mollify-mainview-navlist-parent")),i=n.items,s=function(){var s=r.find(".mollify-mainview-navbar-item");n.classes&&s.addClass(n.classes),n.dropdown&&s.each(function(r,o){var u=i[s.index(this)],a=e('<li class="mollify-mainview-navbar-dropdown"><a href="#" class="dropdown-toggle"><i class="icon-cog"></i></a></li>').appendTo(e(o)),f=[];typeof n.dropdown.items!="function"&&(f=n.dropdown.items),t.ui.controls.dropdown({element:a,items:f,onShow:function(e,t){if(t.length>0)return;typeof n.dropdown.items=="function"&&e.items(n.dropdown.items(u.obj))}})}),s.click(function(){var e=i[s.index(this)];e.callback&&e.callback()}),n.onRender&&n.onRender(r,s,function(e){var t=s.index(e);return i[t].obj})};return s(),{element:r,setActive:function(t){var n=r.find(".mollify-mainview-navbar-item");n.removeClass("active");if(!t)return;e.each(n,function(n,r){var s=i[n].obj;if(!s)return;var u=window.def(t.id)?t.id==s.id:t==s;if(u)return e(r).addClass("active"),!1})},update:function(e){i=e,r.find(".mollify-mainview-navbar-item").remove(),t.dom.template("mollify-tmpl-main-navbar-item",i).appendTo(r),s()}}},this.onResize=function(){n._currentView&&n._currentView.onResize()},this.getSessionActions=function(){var e=[];return t.features.hasFeature("change_password")&&(e.push({"title-key":"mainViewChangePasswordTitle",callback:n.changePassword}),e.push({title:"-"})),e.push({"title-key":"mainViewLogoutTitle",callback:n.onLogout}),e},this.onLogout=function(){t.service.post("session/logout").done(function(e){t.events.dispatch("session/end")})},this.changePassword=function(){var n=!1,r=!1,i=!1,s=!1,o=t.ui.texts.get("mainviewChangePasswordErrorValueMissing"),u=t.ui.texts.get("mainviewChangePasswordErrorConfirm"),a=function(e,r,i){t.service.put("configuration/users/current/password/",{old:window.Base64.encode(e),"new":window.Base64.encode(r)}).done(function(e){i(),t.ui.dialogs.notification({message:t.ui.texts.get("mainviewChangePasswordSuccess")})}).fail(function(e){this.handled=!0,e.code==107?t.ui.dialogs.notification({message:t.ui.texts.get("mainviewChangePasswordError"),type:"error",cls:"full",target:n.find(".modal-footer")}):this.handled=!1})};t.ui.dialogs.custom({title:t.ui.texts.get("mainviewChangePasswordTitle"),content:e("#mollify-tmpl-main-changepassword").tmpl({message:t.ui.texts.get("mainviewChangePasswordMessage")}),buttons:[{id:"yes",title:t.ui.texts.get("mainviewChangePasswordAction"),cls:"btn-primary"},{id:"no",title:t.ui.texts.get("dialogCancel")}],"on-button":function(e,t){var f=!1,l=!1,c=!1;if(e.id==="yes"){n.find(".control-group").removeClass("error"),n.find(".help-inline").text(""),f=r.find("input").val(),l=i.find("input").val(),c=s.find("input").val(),f||(r.addClass("error"),r.find(".help-inline").text(o)),l||(i.addClass("error"),i.find(".help-inline").text(o)),c||(s.addClass("error"),s.find(".help-inline").text(o)),l&&c&&l!=c&&(i.addClass("error"),s.addClass("error"),i.find(".help-inline").text(u),s.find(".help-inline").text(u));if(!f||!l||!c||l!=c)return}e.id==="yes"?a(f,l,t.close):t.close()},"on-show":function(t,o){n=o,r=e("#mollify-mainview-changepassword-old"),i=e("#mollify-mainview-changepassword-new1"),s=e("#mollify-mainview-changepassword-new2"),r.find("input").focus()}})}},t.view.MainViewFileView=function(){var s=this;this.viewId="files",this._currentFolder=!1,this._currentFolderData=!1,this._viewStyle=0,this._selected=[],this._customFolderTypes={},this._selectedItems=[],this._formatters={byteSize:new t.ui.formatters.ByteSize(new t.ui.formatters.Number(2,!1,t.ui.texts.get("decimalSeparator"))),timestamp:new t.ui.formatters.Timestamp(t.ui.texts.get("shortDateTimeFormat")),uploadSpeed:new t.ui.formatters.Number(1,t.ui.texts.get("dataRateKbps"),t.ui.texts.get("decimalSeparator"))},this._filelist={columns:[],addColumn:function(e){s._filelist.columns[e.id]=e}},this._filelist.addColumn({id:"name","title-key":"fileListColumnTitleName",sort:function(e,t,n,r){return e.name.toLowerCase().localeCompare(t.name.toLowerCase())*n},content:function(e,t){return e.name}}),this._filelist.addColumn({id:"path","title-key":"fileListColumnTitlePath",sort:function(e,n,r,i){var s=t.filesystem.rootsById[e.root_id].name+e.path,o=t.filesystem.rootsById[n.root_id].name+n.path;return s.toLowerCase().localeCompare(o.toLowerCase())*r},content:function(e,n){return'<span class="item-path-root">'+t.filesystem.rootsById[e.root_id].name+'</span>: <span class="item-path-val">'+e.path+"</span>"}}),this._filelist.addColumn({id:"type","title-key":"fileListColumnTitleType",sort:function(e,t,n,r){var i=e.is_file?e.extension||"":"",s=t.is_file?t.extension||"":"";return i.toLowerCase().localeCompare(s.toLowerCase())*n},content:function(e,t){return e.is_file?e.extension||"":""}}),this._filelist.addColumn({id:"size","title-key":"fileListColumnTitleSize","min-width":75,sort:function(e,t,n,r){var i=e.is_file?parseInt(e.size,10):0,s=t.is_file?parseInt(t.size,10):0;return(i-s)*n},content:function(e,t){return e.is_file?s._formatters.byteSize.format(e.size):""}}),this._filelist.addColumn({id:"file-modified","request-id":"core-file-modified","title-key":"fileListColumnTitleLastModified",width:180,sort:function(e,t,n,r){if(!e.is_file&&!t.is_file)return 0;if(!r||!r["core-file-modified"])return 0;var i=r["core-file-modified"][e.id]?r["core-file-modified"][e.id]*1:0,s=r["core-file-modified"][t.id]?r["core-file-modified"][t.id]*1:0;return(i>s?1:-1)*n},content:function(e,n){return!e.id||!e.is_file||!n||!n["core-file-modified"]||!n["core-file-modified"][e.id]?"":s._formatters.timestamp.format(t.helpers.parseInternalTime(n["core-file-modified"][e.id]))}}),this._filelist.addColumn({id:"item-description","request-id":"core-item-description","title-key":"fileListColumnTitleDescription",sort:function(e,t,n,r){if(!e.is_file&&!t.is_file)return 0;if(!r||!r["core-item-description"])
return 0;var i=r["core-item-description"][e.id]?r["core-item-description"][e.id]:"",s=r["core-item-description"][t.id]?r["core-item-description"][t.id]:"";return(i>s?1:-1)*n},content:function(e,t){if(!e.id||!t||!t["core-item-description"]||!t["core-item-description"][e.id])return"";var n=t["core-item-description"][e.id],r=n.replace(/<\/?[^>]+(>|$)/g,"");return'<div class="item-description-container" title="'+r+'">'+n+"</div>"}}),this._filelist.addColumn({id:"go-into-folder",title:"",width:25,sort:function(e,t,n,r){return 0},content:function(e,t){return e.is_file?"":'<div class="go-into-folder"><i class="icon-level-down"></i></div>'},"on-init":function(t){t.$i.delegate(".go-into-folder","click",function(n){var r=t.getItemForElement(e(this));if(!r||r.is_file)return;return s.changeToFolder(r),!1})}}),this.init=function(n){s.title=t.ui.texts.get("mainviewMenuTitle"),s.icon="icon-file-alt",t.events.addEventHandler(s.onEvent),s.addCustomFolderType("search",{getFolderInfo:function(n){var r=e.Deferred();return t.service.post("filesystem/search",{text:n.value,rq_data:s.getDataRequest()}).done(function(e){var t=[];for(var n in e.matches)t.push(e.matches[n].item);r.resolve({items:t,data:e.data,info:e})}),r.promise()},onRenderFolderView:function(n,r,i,o){t.dom.template("mollify-tmpl-main-searchresults",{folder:n,info:r}).appendTo(i),e("#mollify-searchresults-title-text").text(t.ui.texts.get("mainViewSearchResultsTitle",[""+r.info.count])),e("#mollify-searchresults-desc-text").text(t.ui.texts.get("mainViewSearchResultsDesc",[n.value]));var u=e("#mollify-fileview-folder-actions");s.addCommonFileviewActions(u)},onItemListRendered:function(n,r,i){var s=function(t){var n="",r=!0;return e.each(t,function(e,t){r||(n+=", "),n+=t.type,r=!1}),n},o=t.ui.texts.get("mainViewSearchResultTooltipMatches");e(".mollify-filelist-item").each(function(){var n=e(this),i=n.tmplItem().data,u=t.filesystem.rootsById[i.root_id].name+"/"+i.path+", "+o+s(r.info.matches[i.id].matches);n.tooltip({placement:"bottom",title:u,trigger:"hover"})})}}),e.each(t.plugins.getFileViewPlugins(),function(e,t){t.fileViewHandler.onInit&&t.fileViewHandler.onInit(s);if(!t.fileViewHandler.filelistColumns)return;var n=t.fileViewHandler.filelistColumns();if(!n)return;for(var r=0;r<n.length;r++)s._filelist.addColumn(n[r])}),s.itemContext=new t.ui.itemContext},this.addCustomFolderType=function(e,t){this._customFolderTypes[e]=t},this.onResize=function(){},this.onActivate=function(r){t.dom.template("mollify-tmpl-fileview").appendTo(r.content),s.showProgress();var i=[];e.each(t.session.folders,function(e,t){i.push({title:t.name,obj:t,callback:function(){s.changeToFolder(t)}})}),s.rootNav=r.addNavBar({title:t.ui.texts.get("mainViewRootsTitle"),items:i,onRender:t.ui.draganddrop?function(e,n,r){t.ui.draganddrop.enableDrop(n,{canDrop:function(e,t,n){if(!n||n.type!="filesystemitem")return!1;var i=n.payload,o=r(e);return s.canDragAndDrop(o,i)},dropType:function(e,t,n){if(!n||n.type!="filesystemitem")return!1;var i=n.payload,o=r(e);return s.dropType(o,i)},onDrop:function(e,t,n){if(!n||n.type!="filesystemitem")return;var i=n.payload,o=r(e);s.onDragAndDrop(o,i)}})}:!1}),s.initViewTools(r.tools),s.initList(),s.uploadProgress=new n(e("#mollify-mainview-progress")),s._dndUploader=!1,t.ui.uploader&&t.ui.uploader.initDragAndDropUploader&&(s._dndUploader=t.ui.uploader.initDragAndDropUploader({container:t.App.getElement(),dropElement:e("#mollify-folderview"),handler:s._getUploadHandler()})),s._scrollOutThreshold=1e5,s._scrollInThreshold=0,e(window).bind("scroll",s._updateScroll),e.each(t.plugins.getFileViewPlugins(),function(t,n){n.fileViewHandler.onActivate&&n.fileViewHandler.onActivate(e("#mollify"),r)});if(t.filesystem.roots.length===0){s.showNoRoots();return}var o=t.request.getParams();if(o.path){t.filesystem.findFolder({path:o.path},s.getDataRequest()).done(function(e){var t=e.folder;s.changeToFolder(t)}).fail(function(e){e.code==203&&(t.ui.dialogs.error({message:t.ui.texts.get("mainviewFolderNotFound",o.path)}),this.handled=!0),s.hideProgress(),s.openInitialFolder()});return}r.id?s.changeToFolder(r.id.join("/")).fail(function(){this.handled=!0,s.hideProgress(),s.openInitialFolder()}):s.openInitialFolder()},this.onRestoreView=function(e){s.changeToFolder(e.join("/"),!0)},this._getUploadHandler=function(e){return{start:function(e,n){s.uploadProgress.show(t.ui.texts.get(e.length>1?"mainviewUploadProgressManyMessage":"mainviewUploadProgressOneMessage",e.length),function(){n()})},progress:function(e,t){var n="";t&&(n=s._formatters.uploadSpeed.format(t/1024)),s.uploadProgress.set(e,n)},finished:function(){e&&e.close(),s.uploadProgress.hide(),t.ui.dialogs.notification({message:t.ui.texts.get("mainviewFileUploadComplete"),type:"success"}),s.refresh()},failed:function(){e&&e.close(),s.uploadProgress.hide(),t.ui.dialogs.notification({message:t.ui.texts.get("mainviewFileUploadFailed"),type:"error"})}}},this._updateScroll=function(){var t=e(window).scrollTop(),n=e("#mollify-folderview"),r=n.hasClass("detached"),i=!r&&t>s._scrollOutThreshold||r&&t<s._scrollInThreshold;if(!i)return;r?e("#mollify-folderview").removeClass("detached"):e("#mollify-folderview").addClass("detached")},this.openInitialFolder=function(){t.filesystem.roots.length===0?s.showNoRoots():t.filesystem.roots.length==1?s.changeToFolder(t.filesystem.roots[0]):s.changeToFolder(null)},this.onDeactivate=function(){e(window).unbind("scroll"),s._dndUploader&&s._dndUploader.destroy(),e.each(t.plugins.getFileViewPlugins(),function(e,t){t.fileViewHandler.onDeactivate&&t.fileViewHandler.onDeactivate()})},this.initViewTools=function(n){t.dom.template("mollify-tmpl-fileview-tools").appendTo(n),t.ui.process(n,["radio"],s),s.controls["mollify-fileview-style-options"].set(s._viewStyle);var r=function(){var t=e("#mollify-fileview-search-input").val();if(!t||t.length===0)return;e("#mollify-fileview-search-input").val(""),s.changeToFolder({type:"search",value:t})};e("#mollify-fileview-search-input").keyup(function(e){e.which==13&&r()}),e("#mollify-fileview-search > button").click(r)},this.getDataRequest=function(){var t=!s._currentFolder||!s._currentFolder.type?{"core-parent-description":{}}:{};return e.extend(t,s.itemWidget.getDataRequest?s.itemWidget.getDataRequest():{})},this.getCurrentFolder=function(){return s._currentFolder},this.onEvent=function(e){if(!e.type.startsWith("filesystem/"))return;s.refresh()},this.onRadioChanged=function(e,t,n){e=="mollify-fileview-style-options"&&s.onViewStyleChanged(t,n)},this.onViewStyleChanged=function(e,t){s._viewStyle=t,s.initList(),s.refresh()},this.showNoRoots=function(){s._currentFolder=!1,s._currentFolderData={items:t.filesystem.roots},s._updateUI()},this.showProgress=function(){e("#mollify-folderview-items").addClass("loading")},this.hideProgress=function(){e("#mollify-folderview-items").removeClass("loading")},this.changeToFolder=function(e,n){var r=e;return e&&typeof e!="string"&&(r=s._getFolderPublicId(e)),n||t.App.storeView("files/"+r),s._currentFolder&&s._currentFolder.type&&s._customFolderTypes[s._currentFolder.type]&&s._customFolderTypes[s._currentFolder.type].onFolderDeselect&&s._customFolderTypes[s._currentFolder.type].onFolderDeselect(s._currentFolder),window.scrollTo(0,0),s._selectedItems=[],s._currentFolder=!1,s._currentFolderData=!1,s.rootNav.setActive(!1),s._onSelectFolder(r)},this._getFolderPublicId=function(e){return e?e.type&&s._customFolderTypes[e.type]?e.type+"/"+e.id:e.id:""},this._onSelectFolder=function(n){var r=function(){s.hideProgress()};t.ui.hideActivePopup(),s.showProgress();var i=n?n.split("/"):[];return i.length>1&&s._customFolderTypes[i[0]]?s._customFolderTypes[i[0]].onSelectFolder(i[1]).done(s._setFolder).fail(r):!n||i.length==1?t.filesystem.folderInfo(n?i[0]:null,!0,s.getDataRequest()).done(function(e){var t=e.folder,n=e;n.items=e.folders.slice(0).concat(e.files),s._setFolder(t,n)}).fail(r):(s.hideProgress(),e.Deferred().reject())},this.refresh=function(){if(!s._currentFolder)return;s._onSelectFolder(s._getFolderPublicId(s._currentFolder))},this._setFolder=function(e,t){s._currentFolder=e,s._currentFolderData=t,s.hideProgress(),s._updateUI()},this._canWrite=function(){return s._currentFolderData?s._currentFolderData.permission=="RW"||s._currentFolderData.permission=="WD":!1},this.onRetrieveUrl=function(e){if(!s._currentFolder)return;s.showProgress(),t.service.post("filesystem/"+s._currentFolder.id+"/retrieve",{url:e}).done(function(e){s.hideProgress(),s.refresh()}).fail(function(n){s.hideProgress(),n.code==301&&(this.handled=!0,t.ui.views.dialogs.error({message:t.ui.texts.get("mainviewRetrieveFileResourceNotFound",[e])}))})},this.dropType=function(e,t){var n=!1;window.isArray(t)?t.length===0&&(n=t[0]):n=t;var r=!n||e.root_id!=n.root_id;return r?"copy":"move"},this.canDragAndDrop=function(e,n){var r=!1;window.isArray(n)?n.length===0&&(r=n[0]):r=n;if(r)return s.dropType(e,r)=="copy"?t.filesystem.canCopyTo(r,e):t.filesystem.canMoveTo(r,e);var i=!0;for(var o=0;o<n.length;o++){var u=n[o];if(s.dropType(e,u)=="copy"?!t.filesystem.canCopyTo(u,e):!t.filesystem.canMoveTo(u,e)){i=!1;break}}return i},this.onDragAndDrop=function(e,n){var r=s.dropType(e,n)=="copy";r?t.filesystem.copy(n,e):t.filesystem.move(n,e)},this._updateUI=function(){var n={title:function(){return this.data.title?this.data.title:t.ui.texts.get(this.data["title-key"])}},r=e("#mollify-folderview-header-content").empty();if(s._currentFolder&&s._currentFolder.type)s._customFolderTypes[s._currentFolder.type]&&s._customFolderTypes[s._currentFolder.type].onRenderFolderView(s._currentFolder,s._currentFolderData,r,o);else{var i=s._currentFolderData&&s._currentFolderData.hierarchy?s._currentFolderData.hierarchy[0]:!1;s.rootNav.setActive(i),s._currentFolder?t.dom.template("mollify-tmpl-fileview-header",{canWrite:s._canWrite(),folder:s._currentFolder}).appendTo(r):t.dom.template("mollify-tmpl-main-rootfolders").appendTo(r);var o=e("#mollify-fileview-folder-tools").empty(),u=e("#mollify-fileview-folder-actions");if(s._currentFolder){if(s._canWrite()){t.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-folder-close"},n).appendTo(o).click(function(){return t.ui.controls.dynamicBubble({element:e(this),content:t.dom.template("mollify-tmpl-main-createfolder-bubble"),handler:{onRenderBubble:function(n){var r=e("#mollify-mainview-createfolder-name-input"),i=function(){var e=r.val();if(!e)return;n.hide(),t.filesystem.createFolder(s._currentFolder,e)};e("#mollify-mainview-createfolder-button").click(i),r.bind("keypress",function(e){(e.keyCode||e.which)==13&&i()}).focus()}}}),!1}),t.ui.uploader&&t.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-download-alt"},n).appendTo(o).click(function(){return t.ui.controls.dynamicBubble({element:e(this),content:t.dom.template("mollify-tmpl-main-addfile-bubble"),handler:{onRenderBubble:function(n){t.ui.uploader.initUploadWidget(e("#mollify-mainview-addfile-upload"),{url:t.filesystem.getUploadUrl(s._currentFolder),handler:s._getUploadHandler(n)}),t.features.hasFeature("retrieve_url")||e("#mollify-mainview-addfile-retrieve").remove();var r=function(){var t=e("#mollify-mainview-addfile-retrieve-url-input").val();if(!t||t.length<1||t.substring(0,4).toLowerCase().localeCompare("http")!==0)return!1;n.close(),s.onRetrieveUrl(t)};e("#mollify-mainview-addfile-retrieve-url-input").bind("keypress",function(e){(e.keyCode||e.which)==13&&r()}),e("#mollify-mainview-addfile-retrieve-button").click(r)}}}),!1});var a=t.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-cog",dropdown:!0},n).appendTo(u);t.ui.controls.dropdown({element:a,items:!1,hideDelay:0,style:"submenu",onShow:function(e,t){if(t)return;s.getItemActions(s._currentFolder,function(t){if(!t){e.hide();return}e.items(t)})}})}s.setupHierarchy(s._currentFolderData.hierarchy,o),s.showProgress()}s._dndUploader&&s._dndUploader.setUrl(s._canWrite()?t.filesystem.getUploadUrl(s._currentFolder):!1),s.addCommonFileviewActions(u)}t.ui.process(r,["localize"]),s._scrollOutThreshold=e("#mollify-folderview-header").outerHeight()+40,s._scrollInThreshold=s._scrollOutThreshold-60,e("#mollify-folderview-detachholder").css("height",s._scrollInThreshold+40+"px"),e("#mollify-folderview").removeClass("detached"),s.onResize(),s._updateSelect();var f=s._currentFolderData.data&&s._currentFolderData.data["core-parent-description"];f&&e("#mollify-folder-description").text(s._currentFolderData.data["core-parent-description"]);var l=e("#mollify-folder-description"),c=s._currentFolder&&!s._currentFolder.type&&l.length>0&&t.session.features.descriptions&&t.session.admin;c?t.ui.controls.editableLabel({element:l,hint:t.ui.texts.get("mainviewDescriptionHint"),onedit:function(e){t.service.put("filesystem/"+s._currentFolder.id+"/description/",{description:e})}}):f||l.hide(),s._updateList(),s.hideProgress()},this.addCommonFileviewActions=function(e){var n={title:function(){return this.data.title?this.data.title:t.ui.texts.get(this.data["title-key"])}};s._selectModeBtn=t.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-check",dropdown:!0,style:"narrow",action:!0},n).appendTo(e).click(s._onToggleSelect),t.ui.controls.dropdown({element:s._selectModeBtn,items:!1,hideDelay:0,style:"submenu",onShow:function(e){s._getSelectionActions(function(t){if(!t){e.hide();return}e.items(t)})}}),t.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-refresh"},n).appendTo(e).click(s.refresh)},this._getViewItems=function(){return s._currentFolderData.items},this._getSelectionActions=function(e){var n=[];if(s._selectMode&&s._selectedItems.length>0){var r=t.plugins.getItemCollectionPlugins(s._selectedItems);n=t.helpers.getPluginActions(r),n.length>0&&n.unshift({title:"-"})}n.unshift({"title-key":"mainViewFileViewSelectNone",callback:function(){s._updateSelect([])}}),n.unshift({"title-key":"mainViewFileViewSelectAll",callback:function(){s._updateSelect(s._getViewItems())}}),e(t.helpers.cleanupActions(n))},this._onToggleSelect=function(){s._selectMode=!s._selectMode,s._updateSelect()},this._updateSelect=function(e){e!==undefined&&(s._selectedItems=e,s._selectMode=!0),s._selectMode?s._selectModeBtn.addClass("active"):s._selectModeBtn.removeClass("active"),s.itemWidget.setSelectMode(s._selectMode),s._selectMode&&s.itemWidget.setSelection(s._selectedItems)},this._getRootItems=function(){var e=[],n=function(e){return function(){s.changeToFolder(e)}};for(var r=0,i=t.session.folders.length;r<i;r++){var o=t.session.folders[r];e.push({title:o.name,callback:n(o)})}return e},this.setupHierarchy=function(n,r){var i=n,o=r.append(t.dom.template("mollify-tmpl-fileview-folder-hierarchy",{items:i}));t.ui.controls.dropdown({element:e("#mollify-folder-hierarchy-item-root"),items:s._getRootItems(),hideDelay:0,style:"submenu"});var u=e(".mollify-folder-hierarchy-item").click(function(){var t=e(this).tmplItem().data;s.changeToFolder(t)});t.ui.draganddrop&&t.ui.draganddrop.enableDrop(u.find("a"),{canDrop:function(e,t,n){if(!n||n.type!="filesystemitem")return!1;var r=n.payload,i=e.parent().tmplItem().data;return s.canDragAndDrop(i,r)},dropType:function(e,t,n){if(!n||n.type!="filesystemitem")return!1;var r=n.payload,i=e.tmplItem().data;return s.dropType(i,r)},onDrop:function(e,t,n){if(!n||n.type!="filesystemitem")return;var r=n.payload,i=e.parent().tmplItem().data;s.onDragAndDrop(i,r)}})},this.isListView=function(){return s._viewStyle===0},this._handleCustomAction=function(n,r,i){if(!t.settings["file-view"]||!t.settings["file-view"].actions)return!1;var o=t.settings["file-view"].actions;if(!o[n]||typeof o[n]!="function")return!1;var u={item:r,viewtype:s.isListView()?"list":"icon",target:i,element:s.itemWidget.getItemContextElement(r),viewport:s.itemWidget.getContainerElement(),container:e("#mollify-folderview-items"),folder:s._currentFolder,folder_permission:s._currentFolderData?s._currentFolderData.permission:!1},a=o[n](r,u);return a?(typeof a=="string"&&(a=="open_popup"?s.itemContext.open(u):a=="open_menu"?s.showActionMenu(r,u.element):!r.is_file&&a=="go_into_folder"&&s.changeToFolder(r)),!0):!1},this.initList=function(){var n=e("#mollify-folderview-header-items").empty();if(s.isListView()){var o=t.settings["list-view-columns"];s.itemWidget=new i("mollify-folderview-items",n,"main",this._filelist,o)}else{var u=!!t.session.features.thumbnails;s.itemWidget=new r("mollify-folderview-items",n,"main",s._viewStyle==1?"iconview-small":"iconview-large",u)}s.itemWidget.init({onFolderSelected:s.onFolderSelected,canDrop:s.canDragAndDrop,dropType:s.dropType,onDrop:s.onDragAndDrop,onClick:function(t,n,r){if(s._handleCustomAction("onClick",t,n))return;if(s.isListView()&&n!="icon"){var i=s._filelist.columns[n];if(i["on-click"]){i["on-click"](t,s._currentFolderData.data);return}}var o=!1;if(s.isListView()){if(!t.is_file)n=="name"?s.changeToFolder(t):n=="icon"&&(o=!0);else if(n=="name"||n=="icon")o=!0}else n=="info"||t.is_file?o=!0:s.changeToFolder(t);if(o){var u={item:t,viewtype:s.isListView()?"list":"icon",target:n,element:s.itemWidget.getItemContextElement(t),viewport:s.itemWidget.getContainerElement(),container:e("#mollify-folderview-items"),folder:s._currentFolder,folder_permission:s._currentFolderData?s._currentFolderData.permission:!1};s.itemContext.open(u)}},onDblClick:function(e){if(s._handleCustomAction("onDblClick",e))return;if(e.is_file)return;s.changeToFolder(e)},onRightClick:function(e,t,n){if(s._handleCustomAction("onRightClick",e,t))return;s.showActionMenu(e,s.itemWidget.getItemContextElement(e))},onContentRendered:function(e,t){s._currentFolder&&s._currentFolder.type&&s._customFolderTypes[s._currentFolder.type]&&s._customFolderTypes[s._currentFolder.type].onItemListRendered&&s._customFolderTypes[s._currentFolder.type].onItemListRendered(s._currentFolder,s._currentFolderData,e)},getSelectedItems:function(){return!s._selectMode||s._selectedItems.length===0?!1:s._selectedItems},onSelectUnselect:function(e){s._selectedItems.indexOf(e)>=0?s._selectedItems.remove(e):s._selectedItems.push(e),s.itemWidget.setSelection(s._selectedItems)}})},this._updateList=function(){s._items=s._currentFolderData.items,s._itemsById=t.helpers.mapByKey(s._items,"id");if(s._selectedItems){var n=[],r={};e.each(s._selectedItems,function(e,t){var i=s._itemsById[t.id];if(!i||r[t.id])return;n.push(i),r[t.id]=!0}),s._selectedItems=n}s.itemWidget.content(s._items,s._currentFolderData.data),s._selectMode&&s.itemWidget.setSelection(s._selectedItems)},this.showActionMenu=function(e,n){n.addClass("open");var r=t.ui.controls.popupmenu({element:n,onHide:function(){n.removeClass("open"),s.itemWidget.removeHover()}});s.getItemActions(e,function(e){if(!e){r.hide();return}r.items(e)})},this.getItemActions=function(e,n){t.filesystem.itemDetails(e,t.plugins.getItemContextRequestData(e)).done(function(r){if(!r){n([]);return}var i={details:r,folder:s._currentFolder,folder_permission:r.parent_permission};n(t.helpers.cleanupActions(t.helpers.getPluginActions(t.plugins.getItemContextPlugins(e,i))))})}};var n=function(e){var t=this;return this._h=e.height(),t._$title=e.find(".title"),t._$speed=e.find(".speed"),t._$bar=e.find(".bar"),{show:function(n,r){e.css("bottom",0-t._h+"px"),t._$title.text(n?n:""),t._$speed.text(""),t._$bar.css("width","0%"),e.show().animate({bottom:"0"},500,r)},set:function(e,n){t._$bar.css("width",e+"%"),t._$speed.text(n?n:"")},hide:function(n){setTimeout(function(){e.animate({bottom:0-t._h+"px"},500,function(){t._$bar.css("width","0%"),e.hide(),n&&n()})},1e3)}}},r=function(n,r,i,s,o){var u=this;u.$c=e("#"+n),u.viewId="mollify-iconview-"+i,this.init=function(n){u.p=n,r.append("<div class='mollify-iconview-header'></div>"),t.dom.template("mollify-tmpl-iconview",{viewId:u.viewId}).appendTo(u.$c.empty()),u.$l=e("#"+u.viewId),s&&u.$l.addClass(s)},this.content=function(n,r){u.items=n,u.data=r;var i=["jpg","png","gif","jpeg"];t.dom.template("mollify-tmpl-iconview-item",n,{showThumb:function(e){return!o||!e.is_file?!1:i.indexOf(e.extension)>=0},thumbUrl:function(e){return t.service.url("filesystem/"+e.id+"/thumbnail/")},typeClass:function(e){var t=e.is_file?"item-file":"item-folder";return e.is_file&&e.extension?t+=" item-type-"+e.extension:!e.is_file&&e.id==e.root_id&&(t+=" item-root-folder"),t}}).appendTo(u.$l.empty());var s=u.$l.find(".mollify-iconview-item").hover(function(){e(this).addClass("hover")},function(){e(this).removeClass("hover")}).bind("contextmenu",function(t){t.preventDefault();var n=e(this);return u.p.onRightClick(n.tmplItem().data,"",n),!1}).single_double_click(function(t){var n=e(this),r=n.tmplItem().data,i=e(t.target);if(i.hasClass("mollify-iconview-item-sel-option")){u.p.onSelectUnselect(r);return}var s="";i.parent().hasClass("mollify-iconview-item-info")&&(s="info"),u.p.onClick(r,s,n)},function(){u.p.onDblClick(e(this).tmplItem().data)}).attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none","user-select":"none","-ms-user-select":"none"});t.ui.draganddrop&&(t.ui.draganddrop.enableDrag(s,{onDragStart:function(e,t){var n=e.tmplItem().data,r=u.p.getSelectedItems();return r?r.indexOf(n)<0&&r.push(n):r=n,{type:"filesystemitem",payload:r}}}),t.ui.draganddrop.enableDrop(u.$l.find(".mollify-iconview-item.item-folder"),{canDrop:function(e,t,n){if(!u.p.canDrop||!n||n.type!="filesystemitem")return!1;var r=n.payload,i=e.tmplItem().data;return u.p.canDrop(i,r)},dropType:function(e,t,n){if(!u.p.dropType||!n||n.type!="filesystemitem")return!1;var r=n.payload,i=e.tmplItem().data;return u.p.dropType(i,r)},onDrop:function(e,t,n){if(!n||n.type!="filesystemitem")return;var r=n.payload,i=e.tmplItem().data;u.p.onDrop&&u.p.onDrop(i,r)}})),u.p.onContentRendered(n,r)},this.getItemContextElement=function(e){return u.$l.find("#mollify-iconview-item-"+e.id)},this.getContainerElement=function(){return u.$l},this.removeHover=function(){u.$l.find(".mollify-iconview-item.hover").removeClass("hover")},this.setSelectMode=function(e){u.$l.find(".mollify-iconview-item.selected").removeClass("selected"),e?u.$l.addClass("select"):u.$l.removeClass("select")},this.setSelection=function(t){u.$l.find(".mollify-iconview-item.selected").removeClass("selected"),e.each(t,function(e,t){u.$l.find("#mollify-iconview-item-"+t.id).addClass("selected")})}},i=function(n,r,i,s,o){var u=this;u.minColWidth=25,u.$c=e("#"+n),u.$hc=r,u.listId="mollify-filelist-"+i,u.cols=[],u.sortCol=!1,u.sortOrderAsc=!0,u.colWidths={};for(var a in o){var f=s.columns[a];if(!f)continue;var l=e.extend({},f,o[a]);u.cols.push(l)}this.init=function(n){u.p=n,t.dom.template("mollify-tmpl-filelist-header",{listId:u.listId}).appendTo(u.$hc.empty()),t.dom.template("mollify-tmpl-filelist",{listId:u.listId}).appendTo(u.$c.empty()),u.$l=e("#"+u.listId),u.$h=e("#"+u.listId+"-header-cols"),u.$i=e("#"+u.listId+"-items"),t.dom.template("mollify-tmpl-filelist-headercol",u.cols,{title:function(e){var n=e["title-key"];return n?t.ui.texts.get(n):""}}).appendTo(u.$h),u.$h.find(".mollify-filelist-col-header").each(function(t){var n=e(this),r=n.index();if(r<=1)return;var i=u.cols[r-2],s=i["min-width"]||u.minColWidth;n.css("min-width",s),i.width&&n.css("width",i.width),n.find(".mollify-filelist-col-header-title").click(function(){u.onSortClick(i)}),t!=u.cols.length-1&&n.resizable({handles:"e",minWidth:s,start:function(e,t){var r=u.$c.width()-u.cols.length*u.minColWidth;n.resizable("option","maxWidth",r)},stop:function(e,t){var r=n.width();u.colWidths[i.id]=r,u.updateColWidth(i.id,r)}}),i["on-init"]&&i["on-init"](u)}),u.items=[],u.data={},u.onSortClick(u.cols[0])},this.updateColWidths=function(){for(var e in u.colWidths)u.updateColWidth(e,u.colWidths[e])},this.updateColWidth=function(t,n){e(".mollify-filelist-col-"+t).width(n)},this.onSortClick=function(e){e.id!=u.sortCol.id?(u.sortCol=e,u.sortOrderAsc=!0):u.sortOrderAsc=!u.sortOrderAsc,u.refreshSortIndicator(),u.content(u.items,u.data)},this.sortItems=function(){var e=u.sortCol.sort;u.items.sort(function(t,n){return e(t,n,u.sortOrderAsc?1:-1,u.data)})},this.refreshSortIndicator=function(){u.$h.find(".mollify-filelist-col-header").removeClass("sort-asc").removeClass("sort-desc"),e("#mollify-filelist-col-header-"+u.sortCol.id).addClass("sort-"+(u.sortOrderAsc?"asc":"desc"))},this.getDataRequest=function(){var e={};for(var t=0,n=u.cols.length;t<n;t++){var r=u.cols[t];r["request-id"]&&(e[r["request-id"]]={})}return e},this.content=function(n,r){u.items=n,u.data=r,u.sortItems(),t.dom.template("mollify-tmpl-filelist-item",n,{cols:u.cols,typeClass:function(e){var t=e.is_file?"item-file":"item-folder";return e.is_file&&e.extension?t+=" item-type-"+e.extension:!e.is_file&&e.id==e.root_id&&(t+=" item-root-folder"),t},col:function(e,t){return t.content(e,u.data)},itemColStyle:function(e,t){var n="min-width:"+(t["min-width"]||u.minColWidth)+"px";return t.width&&(n=n+";width:"+t.width+"px"),n}}).appendTo(u.$i.empty());for(var i=0,s=u.cols.length;i<s;i++){var o=u.cols[i];o["on-render"]&&o["on-render"](u)}var a=u.$i.find(".mollify-filelist-item");a.hover(function(){e(this).addClass("hover")},function(){e(this).removeClass("hover")}).bind("contextmenu",function(t){return t.preventDefault(),u.onItemClick(e(this),e(t.toElement||t.target),!1),!1}).single_double_click(function(t){return t.preventDefault(),t.stopPropagation(),u.onItemClick(e(this),e(t.toElement||t.target),!0),!1},function(){u.p.onDblClick(e(this).tmplItem().data)}),t.ui.draganddrop&&(t.ui.draganddrop.enableDrag(a,{onDragStart:function(e,t){var n=e.tmplItem().data,r=u.p.getSelectedItems();return r?r.indexOf(n)<0&&r.push(n):r=n,{type:"filesystemitem",payload:r}}}),t.ui.draganddrop.enableDrop(u.$i.find(".mollify-filelist-item.item-folder"),{canDrop:function(e,t,n){if(!u.p.canDrop||!n||n.type!="filesystemitem")return!1;var r=n.payload,i=e.tmplItem().data;return u.p.canDrop(i,r)},dropType:function(e,t,n){if(!u.p.dropType||!n||n.type!="filesystemitem")return!1;var r=n.payload,i=e.tmplItem().data;return u.p.dropType(i,r)},onDrop:function(e,t,n){if(!n||n.type!="filesystemitem")return;var r=n.payload,i=e.tmplItem().data;u.p.onDrop&&u.p.onDrop(i,r)}})),u.updateColWidths(),u.p.onContentRendered(n,r)},this.onItemClick=function(e,t,n){var r=e.find(".mollify-filelist-col").index(t.closest(".mollify-filelist-col"));if(r<0)return;var i=e.tmplItem().data;if(r===0){u.p.onSelectUnselect(i);return}var s=r===1?"icon":u.cols[r-2].id;n?u.p.onClick(i,s,e):u.p.onRightClick(i,s,e)},this.getItemContextElement=function(e){var t=u.$i.find("#mollify-filelist-item-"+e.id);return t.find(".mollify-filelist-col-name")||t},this.getItemForElement=function(e){return e.tmplItem().data},this.getContainerElement=function(){return u.$i},this.removeHover=function(){u.$i.find(".mollify-filelist-item.hover").removeClass("hover")},this.setSelectMode=function(e){u.$i.find(".mollify-filelist-item.selected").removeClass("selected"),e?(u.$l.addClass("select"),u.$h.addClass("select")):(u.$l.removeClass("select"),u.$h.removeClass("select"))},this.setSelection=function(t){u.$i.find(".mollify-filelist-item.selected").removeClass("selected"),e.each(t,function(e,t){u.$i.find("#mollify-filelist-item-"+t.id).addClass("selected")})}}}(window.jQuery,window.mollify),!function(e,t){"use strict";t.view.MainViewConfigView=function(){var n=this;this.viewId="admin",this._views=[],this._adminViews=[],this._adminViewsLoaded=!1,this.init=function(r){n.title=t.ui.texts.get("configviewMenuTitle"),n.icon="icon-cogs",n._views.push(new t.view.config.user.AccountView(r)),e.each(t.plugins.getConfigViewPlugins(),function(t,r){if(!r.configViewHandler.views)return;var i=r.configViewHandler.views();if(!i)return;e.each(i,function(e,t){n._views.push(t)})})},this.onResize=function(){},this.onActivate=function(r){t.templates.load("configview",t.templates.url("configview.html")).done(function(){t.dom.template("mollify-tmpl-configview").appendTo(r.content),n.showLoading(!0);var i=[];e.each(n._views,function(e,t){i.push({title:t.title,obj:t,callback:function(){n._activateView(t)}})}),n._userNav=r.addNavBar({title:t.ui.texts.get("configViewUserNavTitle"),items:i}),n.onResize();if(t.session.admin)if(n._adminViewsLoaded)n._initAdminViews(r);else{n._adminViewsLoaded=!0,n._adminViews.push(new t.view.config.admin.FoldersView),n._adminViews.push(new t.view.config.admin.UsersView),n._adminViews.push(new t.view.config.admin.GroupsView);var s=[];for(var o in t.session.plugins){if(!t.session.plugins[o]||!t.session.plugins[o].admin)continue;s.push(o)}t.admin={plugins:[]},n._loadAdminPlugins(s).done(function(){n._initAdminViews(r)})}})},this._loadAdminPlugins=function(r){var i=e.Deferred(),s=[];s.push(t.service.get("configuration/settings").done(function(e){n._settings=e}));for(var o=0,u=r.length;o<u;o++)s.push(t.dom.importScript(t.plugins.url(r[o],"plugin.js",!0)));return e.when.apply(e,s).done(function(){var r=[],s=function(e,t){n._adminViews.push(t)};for(var o in t.admin.plugins){var u=t.admin.plugins[o];if(!u||!u.views)continue;u.resources&&u.resources.texts&&r.push(t.ui.texts.loadPlugin(o)),e.each(u.views,s)}e.when.apply(e,r).done(i.resolve)}),i},this._initAdminViews=function(r){if(!t.session.admin||n._adminViews.length===0)return;e.each(n._adminViews,function(e,t){t.init&&t.init(n._settings,n)});var i=[];e.each(n._adminViews,function(e,t){i.push({title:t.title,obj:t,callback:function(){n._activateView(t,!0)}})}),n._adminNav=r.addNavBar({title:t.ui.texts.get("configViewAdminNavTitle"),items:i});if(r.id){var s=n._findView(r.id[0]);s&&n._activateView(s.view,s.admin)}else n._activateView(n._views[0])},this._findView=function(t){var r=!1;return e.each(n._views,function(e,n){if(n.viewId==t)return r={view:n,admin:!1},!1}),r||e.each(n._adminViews,function(e,n){if(n.viewId==t)return r={view:n,admin:!0},!1}),r},this.onRestoreView=function(e){var t=n._findView(e[0]);t&&n._activateView(t.view,t.admin,!0)},this._activateView=function(r,i,s){n._activeView&&(n._activeView.onDeactivate&&n._activeView.onDeactivate(),n._adminNav&&n._adminNav.setActive(!1),n._userNav.setActive(!1)),i?n._adminNav.setActive(r):n._userNav.setActive(r),n.showLoading(!1),n._activeView=r,!s&&n._activeView.viewId&&t.App.storeView("admin/"+n._activeView.viewId),e("#mollify-configview-header").html(r.title),r.onActivate(n._getContentElement().empty(),n)},this._getContentElement=function(){return e("#mollify-configview-content")},this.onDeactivate=function(){n._activeView&&n._activeView.onDeactivate&&n._activeView.onDeactivate()},this.showLoading=function(e){e?n._getContentElement().find(".mollify-configlistview").addClass("loading"):n._getContentElement().find(".mollify-configlistview").removeClass("loading")}},t.view.ConfigListView=function(n,r){t.dom.template("mollify-tmpl-configlistview",{title:r.title,actions:r.actions||!1}).appendTo(n);var i=n.find(".mollify-configlistview-table"),s=t.ui.controls.table(i,r.table),o=function(e,t){t?n.find("#mollify-configlistview-action-"+e).removeClass("disabled"):n.find("#mollify-configlistview-action-"+e).addClass("disabled")};return r.actions&&(s.onSelectionChanged(function(){var t=s.getSelected(),n=t.length>0,i=t.length==1,u=t.length>1;e.each(r.actions,function(e,t){if(!t.depends)return;t.depends=="table-selection"?o(t.id,n):t.depends=="table-selection-one"?o(t.id,i):t.depends=="table-selection-many"&&o(t.id,u)})}),n.find(".mollify-configlistview-actions > .mollify-configlistview-action").click(function(){if(e(this).hasClass("disabled"))return;var t=e(this).tmplItem().data;if(!t.callback)return;var n;t.depends&&t.depends.startsWith("table-selection")&&(n=s.getSelected()),t.callback(n)})),{table:s,enableAction:o}},t.view.config={user:{},admin:{}},t.view.config.user.AccountView=function(n){var r=this;this.viewId="account",this.title=t.ui.texts.get("configUserAccountNavTitle"),this.onActivate=function(r){t.dom.template("mollify-tmpl-config-useraccountview",t.session).appendTo(r),t.ui.process(r,["localize"]),e("#user-account-change-password-btn").click(n.changePassword)}},t.view.config.admin.UsersView=function(){var n=this;this.viewId="users",this.init=function(e,r){n._cv=r,n.title=t.ui.texts.get("configAdminUsersNavTitle"),n._permissionOptions=["a","rw","wd","ro","no"],n._permissionTexts={a:t.ui.texts.get("configAdminUsersPermissionModeAdmin"),rw:t.ui.texts.get("pluginPermissionsValueRW"),wd:t.ui.texts.get("pluginPermissionsValueWD"),ro:t.ui.texts.get("pluginPermissionsValueRO"),no:t.ui.texts.get("pluginPermissionsValueNO")},n._authenticationOptions=e.authentication_methods,n._authFormatter=function(e){return e},n._defaultAuthMethod=e.authentication_methods[0],n._langFormatter=function(e){return t.ui.texts.get("language_"+e)}},this.onActivate=function(r){var i=!1,s=!1;n._details=t.ui.controls.slidePanel(e("#mollify-mainview-viewcontent"),{resizable:!0});var o=function(t){var n={criteria:{}},r=e("#mollify-admin-user-searchoptions-name").val();r&&r.length>0&&
(n.criteria.name=r);var i=e("#mollify-admin-user-searchoptions-email").val();return i&&i.length>0&&(n.criteria.email=i),n},u=function(){n._cv.showLoading(!0),s.table.refresh().done(function(){n._cv.showLoading(!1)})},a=function(){n._details.hide(),u()};s=new t.view.ConfigListView(r,{actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:function(){n.onAddEditUser(!1,a)}},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(e){t.ui.dialogs.confirmation({title:t.ui.texts.get("configAdminUsersRemoveUsersConfirmationTitle"),message:t.ui.texts.get("configAdminUsersRemoveUsersConfirmationMessage",[e.length]),callback:function(){n._removeUsers(e).done(a)}})}},{id:"action-refresh",content:'<i class="icon-refresh"></i>',callback:u}],table:{id:"config-admin-users",key:"id",narrow:!0,hilight:!0,remote:{path:"configuration/users/query",paging:{max:50},queryParams:o,onLoad:function(e){r.addClass("loading"),e.done(function(){r.removeClass("loading")})}},columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-user"></i>'},{id:"name",title:t.ui.texts.get("configAdminUsersNameTitle"),sortable:!0},{id:"permission_mode",title:t.ui.texts.get("configAdminUsersPermissionTitle"),sortable:!0,valueMapper:function(e,t){var r=t.toLowerCase();return n._permissionTexts[r]?n._permissionTexts[r]:t}},{id:"email",title:t.ui.texts.get("configAdminUsersEmailTitle"),sortable:!0},{id:"edit",title:t.ui.texts.get("configAdminActionEditTitle"),type:"action",content:'<i class="icon-edit"></i>'},{id:"pw",title:t.ui.texts.get("configAdminUsersActionChangePasswordTitle"),type:"action",content:'<i class="icon-key"></i>'},{id:"remove",title:t.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(e,r){e=="edit"?t.service.get("configuration/users/"+r.id).done(function(e){n.onAddEditUser(e,a)}):e=="pw"?n.onChangePassword(r):e=="remove"&&t.ui.dialogs.confirmation({title:t.ui.texts.get("configAdminUsersRemoveUserConfirmationTitle"),message:t.ui.texts.get("configAdminUsersRemoveUserConfirmationMessage",[r.name]),callback:function(){t.service.del("configuration/users/"+r.id).done(a)}})},onHilight:function(e){e?(n._showUserDetails(e,n._details.getContentElement().empty(),n._allGroups,n._allFolders),n._details.show(!1,400)):n._details.hide()}}}),n._cv.showLoading(!0);var f=r.find(".mollify-configlistview-options");t.dom.template("mollify-tmpl-config-admin-user-searchoptions").appendTo(f),t.ui.process(f,["localize"]);var l=t.service.get("configuration/usergroups").done(function(e){n._allGroups=e}),c=t.service.get("configuration/folders").done(function(e){n._allFolders=e});e.when(l,c).done(u)},this.onChangePassword=function(r,i){var s=!1,o=!1,u=!1;t.ui.dialogs.custom({resizable:!0,initSize:[600,200],title:t.ui.texts.get("configAdminUsersChangePasswordDialogTitle",r.name),content:t.dom.template("mollify-tmpl-config-admin-userchangepassworddialog",{user:r}),buttons:[{id:"yes",title:t.ui.texts.get("dialogSave")},{id:"no",title:t.ui.texts.get("dialogCancel")}],"on-button":function(e,n){if(e.id=="no"){n.close();return}var s=u.val();if(!s||s.length===0)return;t.service.put("configuration/users/"+r.id+"/password",{"new":window.Base64.encode(s)}).done(n.close).done(i)},"on-show":function(i,o){e("#change-password-title").text(t.ui.texts.get("configAdminUsersChangePasswordTitle",r.name)),s=o.find("#mollify-config-admin-userchangepassworddialog-content"),u=o.find("#passwordField"),e("#generatePasswordBtn").click(function(){return u.val(n._generatePassword()),!1}),u.focus(),i.center()}})},this.onDeactivate=function(){n._details.remove()},this._showUserDetails=function(n,r,i,s){t.dom.template("mollify-tmpl-config-admin-userdetails",{user:n}).appendTo(r),t.ui.process(r,["localize"]);var o=r.find(".mollify-config-admin-userdetails-groups"),u=r.find(".mollify-config-admin-userdetails-folders"),a=!1,f=!1,l=!1,c=!1,h=function(){o.addClass("loading"),t.service.get("configuration/users/"+n.id+"/groups/").done(function(e){o.removeClass("loading"),c=e,f.table.set(c)})},p=function(){u.addClass("loading"),t.service.get("configuration/users/"+n.id+"/folders/").done(function(e){u.removeClass("loading"),l=e,a.table.set(l)})},d=function(){var r=t.helpers.extractValue(l,"id"),i=t.helpers.filter(s,function(e){return r.indexOf(e.id)<0});t.ui.dialogs.select({title:t.ui.texts.get("configAdminUserAddFolderTitle"),message:t.ui.texts.get("configAdminUserAddFolderMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUsersFolderDefaultNameTitle")},{id:"user_name",title:t.ui.texts.get("configAdminUsersFolderNameTitle"),type:"input"},{id:"path",title:t.ui.texts.get("configAdminFoldersPathTitle")}],list:i,onSelect:function(r,i){var s=[];e.each(r,function(e,t){var n={id:t.id},r=i[t.id]?i[t.id].user_name:!1;r&&t.name!=r&&(n.name=r),s.push(n)}),t.service.post("configuration/users/"+n.id+"/folders/",s).done(p)}})},v=function(){var e=t.helpers.extractValue(c,"id"),r=t.helpers.filter(i,function(t){return e.indexOf(t.id)<0});t.ui.dialogs.select({title:t.ui.texts.get("configAdminUserAddGroupTitle"),message:t.ui.texts.get("configAdminUserAddGroupMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUsersGroupNameTitle")},{id:"description",title:t.ui.texts.get("configAdminGroupsDescriptionTitle")}],list:r,onSelect:function(e,r){t.service.post("configuration/users/"+n.id+"/groups/",t.helpers.extractValue(e,"id")).done(h)}})};a=new t.view.ConfigListView(r.find(".mollify-config-admin-userdetails-folders"),{title:t.ui.texts.get("configAdminUsersFoldersTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:d},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(e){t.service.del("configuration/users/"+n.id+"/folders/",{ids:t.helpers.extractValue(e,"id")}).done(p)}}],table:{id:"config-admin-userfolders",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUsersFolderNameTitle"),valueMapper:function(e,n){var r=e.name;return r&&r.length>0?r:t.ui.texts.get("configAdminUsersFolderDefaultName",e.default_name)}},{id:"path",title:t.ui.texts.get("configAdminFoldersPathTitle")},{id:"remove",title:t.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(e,r){e=="remove"&&t.service.del("configuration/users/"+n.id+"/folders/"+r.id).done(p)}}}),f=new t.view.ConfigListView(r.find(".mollify-config-admin-userdetails-groups"),{title:t.ui.texts.get("configAdminUsersGroupsTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:v},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(e){t.service.del("configuration/users/"+n.id+"/groups/",{ids:t.helpers.extractValue(e,"id")}).done(h)}}],table:{id:"config-admin-usergroups",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-user"></i>'},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUsersGroupNameTitle")},{id:"remove",title:t.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(e,r){e=="remove"&&t.service.del("configuration/users/"+n.id+"/groups/"+r.id).done(h)}}}),h(),p()},this._generatePassword=function(){var e=8,t="",r;for(var i=0;i<e;i++){for(;;){r=parseInt(Math.random()*1e3,10)%94+33;if(n._isValidPasswordChar(r))break}t+=String.fromCharCode(r)}return t},this._isValidPasswordChar=function(e){return e>=33&&e<=47?!1:e>=58&&e<=64?!1:e>=91&&e<=96?!1:e>=123&&e<=126?!1:!0},this._removeUsers=function(e){return t.service.del("configuration/users",{ids:t.helpers.extractValue(e,"id")})},this.onAddEditUser=function(r,i){var s=!1,o=!1,u=!1,a=!1,f=!1,l=!1,c=!1,h=!1,p=t.settings.language.options&&t.settings.language.options.length>1;t.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:t.ui.texts.get(r?"configAdminUsersUserDialogEditTitle":"configAdminUsersUserDialogAddTitle"),content:t.dom.template("mollify-tmpl-config-admin-userdialog",{user:r,showLanguages:p}),buttons:[{id:"yes",title:t.ui.texts.get("dialogSave")},{id:"no",title:t.ui.texts.get("dialogCancel")}],"on-button":function(e,n){if(e.id=="no"){n.close();return}var s=o.val(),d=u.val(),v=f.selected(),m=t.helpers.formatInternalTime(h.get()),g=l.selected();if(!s||s.length===0)return;var y=null;p&&(y=c.selected());var b={name:s,email:d,permission_mode:v,expiration:m,auth:g,lang:y};if(r)t.service.put("configuration/users/"+r.id,b).done(n.close).done(i);else{var w=a.val();if(!w||w.length===0)return;b.password=window.Base64.encode(w),t.service.post("configuration/users",b).done(n.close).done(i)}},"on-show":function(i,d){s=d.find("#mollify-config-admin-userdialog-content"),o=d.find("#usernameField"),u=d.find("#emailField"),a=d.find("#passwordField"),e("#generatePasswordBtn").click(function(){return a.val(n._generatePassword()),!1}),f=t.ui.controls.select("permissionModeField",{values:n._permissionOptions,valueMapper:function(e){return n._permissionTexts[e]}}),l=t.ui.controls.select("authenticationField",{values:n._authenticationOptions,none:t.ui.texts.get("configAdminUsersUserDialogAuthDefault",n._defaultAuthMethod),valueMapper:n._authFormatter}),p&&(c=t.ui.controls.select("languageField",{values:t.settings.language.options,none:t.ui.texts.get("configAdminUsersUserDialogLangDefault",t.settings.language["default"]||"en"),valueMapper:n._langFormatter})),h=t.ui.controls.datepicker("expirationField",{format:t.ui.texts.get("shortDateTimeFormat"),time:!0}),r?(o.val(r.name),u.val(r.email||""),f.select(r.permission_mode.toLowerCase()),l.select(r.auth?r.auth.toLowerCase():null),h.set(t.helpers.parseInternalTime(r.expiration)),p&&r.lang&&c.select(r.lang)):f.select("no"),o.focus(),i.center()}})}},t.view.config.admin.GroupsView=function(){var n=this;this.viewId="groups",this.init=function(e,r){n._cv=r,n.title=t.ui.texts.get("configAdminGroupsNavTitle")},this.onActivate=function(r){var i=!1,s=!1;n._details=t.ui.controls.slidePanel(e("#mollify-mainview-viewcontent"),{resizable:!0});var o=function(){n._details.hide(),n._cv.showLoading(!0),t.service.get("configuration/usergroups/").done(function(e){n._cv.showLoading(!1),i=e,s.table.set(i)})};s=new t.view.ConfigListView(r,{actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:function(){n.onAddEditGroup(!1,o)}},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(e){t.ui.dialogs.confirmation({title:t.ui.texts.get("configAdminGroupsRemoveGroupsConfirmationTitle"),message:t.ui.texts.get("configAdminGroupsRemoveGroupsConfirmationMessage",[e.length]),callback:function(){n._removeGroups(e).done(o)}})}},{id:"action-refresh",content:'<i class="icon-refresh"></i>',callback:o}],table:{id:"config-admin-groups",key:"id",narrow:!0,hilight:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-user"></i>'},{id:"name",title:t.ui.texts.get("configAdminUsersNameTitle")},{id:"description",title:t.ui.texts.get("configAdminGroupsDescriptionTitle")},{id:"edit",title:t.ui.texts.get("configAdminActionEditTitle"),type:"action",content:'<i class="icon-edit"></i>'},{id:"remove",title:t.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(e,r){e=="edit"?n.onAddEditGroup(r,o):e=="remove"&&t.ui.dialogs.confirmation({title:t.ui.texts.get("configAdminGroupsRemoveGroupConfirmationTitle"),message:t.ui.texts.get("configAdminGroupsRemoveGroupConfirmationMessage",[r.name]),callback:function(){t.service.del("configuration/usergroups/"+r.id).done(o)}})},onHilight:function(e){e?(n._showGroupDetails(e,n._details.getContentElement().empty(),n._allUsers,n._allFolders),n._details.show(!1,400)):n._details.hide()}}}),o(),n._cv.showLoading(!0);var u=t.service.get("configuration/users").done(function(e){n._allUsers=e}),a=t.service.get("configuration/folders").done(function(e){n._allFolders=e});e.when(u,a).done(function(){n._cv.showLoading(!1)})},this.onDeactivate=function(){n._details.remove()},this._showGroupDetails=function(n,r,i,s){t.dom.template("mollify-tmpl-config-admin-groupdetails",{group:n}).appendTo(r),t.ui.process(r,["localize"]);var o=r.find(".mollify-config-admin-groupdetails-users"),u=r.find(".mollify-config-admin-groupdetails-folders"),a=!1,f=!1,l=!1,c=!1,h=function(){o.addClass("loading"),t.service.get("configuration/usergroups/"+n.id+"/users/").done(function(e){o.removeClass("loading"),c=e,f.table.set(c)})},p=function(){u.addClass("loading"),t.service.get("configuration/users/"+n.id+"/folders/").done(function(e){u.removeClass("loading"),l=e,a.table.set(l)})},d=function(){var e=t.helpers.extractValue(c,"id"),r=t.helpers.filter(i,function(t){return e.indexOf(t.id)<0});t.ui.dialogs.select({title:t.ui.texts.get("configAdminGroupAddUserTitle"),message:t.ui.texts.get("configAdminGroupAddUserMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUsersNameTitle")}],list:r,onSelect:function(e,r){t.service.post("configuration/usergroups/"+n.id+"/users/",t.helpers.extractValue(e,"id")).done(h)}})},v=function(){var r=t.helpers.extractValue(l,"id"),i=t.helpers.filter(s,function(e){return r.indexOf(e.id)<0});t.ui.dialogs.select({title:t.ui.texts.get("configAdminGroupAddFolderTitle"),message:t.ui.texts.get("configAdminGroupAddFolderMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUsersFolderDefaultNameTitle")},{id:"user_name",title:t.ui.texts.get("configAdminUsersFolderNameTitle"),type:"input"},{id:"path",title:t.ui.texts.get("configAdminFoldersPathTitle")}],list:i,onSelect:function(r,i){var s=[];e.each(r,function(e,t){var n={id:t.id},r=i[t.id]?i[t.id].user_name:!1;r&&t.name!=r&&(n.name=r),s.push(n)}),t.service.post("configuration/users/"+n.id+"/folders/",s).done(p)}})};a=new t.view.ConfigListView(u,{title:t.ui.texts.get("configAdminGroupsFoldersTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:v},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(e){t.service.del("configuration/users/"+n.id+"/folders/",{ids:t.helpers.extractValue(e,"id")}).done(p)}}],table:{id:"config-admin-groupfolders",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUsersFolderNameTitle"),valueMapper:function(e,n){var r=e.name;return r&&r.length>0?r:t.ui.texts.get("configAdminUsersFolderDefaultName",e.default_name)}},{id:"path",title:t.ui.texts.get("configAdminFoldersPathTitle")},{id:"remove",title:t.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(e,r){e=="remove"&&t.service.del("configuration/users/"+n.id+"/folders/"+r.id).done(p)}}}),f=new t.view.ConfigListView(o,{title:t.ui.texts.get("configAdminGroupsUsersTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:d},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(e){t.service.post("configuration/usergroups/"+n.id+"/remove_users/",t.helpers.extractValue(e,"id")).done(h)}}],table:{id:"config-admin-groupusers",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUsersNameTitle")},{id:"remove",title:t.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(e,r){e=="remove"&&t.service.post("configuration/usergroups/"+n.id+"/remove_users/",[r.id]).done(h)}}}),h(),p()},this._removeGroups=function(e){return t.service.del("configuration/usergroups",{ids:t.helpers.extractValue(e,"id")})},this.onAddEditGroup=function(e,n){var r=!1,i=!1,s=!1;t.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:t.ui.texts.get(e?"configAdminGroupsDialogEditTitle":"configAdminGroupsDialogAddTitle"),content:t.dom.template("mollify-tmpl-config-admin-groupdialog",{group:e}),buttons:[{id:"yes",title:t.ui.texts.get("dialogSave")},{id:"no",title:t.ui.texts.get("dialogCancel")}],"on-button":function(r,o){if(r.id=="no"){o.close();return}var u=i.val();if(!u||u.length===0)return;var a=s.val(),f={name:u,description:a};e?t.service.put("configuration/usergroups/"+e.id,f).done(o.close).done(n):t.service.post("configuration/usergroups",f).done(o.close).done(n)},"on-show":function(t,n){r=n.find("#mollify-config-admin-groupdialog-content"),i=n.find("#nameField"),s=n.find("#descriptionField"),e&&(i.val(e.name),s.val(e.description||"")),i.focus(),t.center()}})}},t.view.config.admin.FoldersView=function(){var n=this;this.viewId="folders",this.init=function(e,r){n._cv=r,n._settings=e,n.title=t.ui.texts.get("configAdminFoldersNavTitle")},this.onActivate=function(r){var i=!1,s=!1;n._details=t.ui.controls.slidePanel(e("#mollify-mainview-viewcontent"),{resizable:!0});var o=function(){n._cv.showLoading(!0),t.service.get("configuration/folders/").done(function(e){n._cv.showLoading(!1),i=e,s.table.set(i)})};s=new t.view.ConfigListView(r,{actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:function(){n.onAddEditFolder(!1,o)}},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(e){t.ui.dialogs.confirmation({title:t.ui.texts.get("configAdminFoldersRemoveFoldersConfirmationTitle"),message:t.ui.texts.get("configAdminFoldersRemoveFoldersConfirmationMessage",[e.length]),callback:function(){n._removeFolders(e).done(o)}})}},{id:"action-refresh",content:'<i class="icon-refresh"></i>',callback:o}],table:{id:"config-admin-folders",key:"id",narrow:!0,hilight:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-folder-close"></i>'},{id:"name",title:t.ui.texts.get("configAdminFoldersNameTitle")},{id:"path",title:t.ui.texts.get("configAdminFoldersPathTitle")},{id:"edit",title:t.ui.texts.get("configAdminActionEditTitle"),type:"action",content:'<i class="icon-edit"></i>'},{id:"remove",title:t.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(e,r){e=="edit"?n.onAddEditFolder(r,o):e=="remove"&&t.ui.dialogs.confirmation({title:t.ui.texts.get("configAdminFoldersRemoveFolderConfirmationTitle"),message:t.ui.texts.get("configAdminFoldersRemoveFolderConfirmationMessage",[r.name]),callback:function(){t.service.del("configuration/folders/"+r.id).done(o)}})},onHilight:function(e){e?(n._showFolderDetails(e,n._details.getContentElement().empty(),n._allGroups,n._allUsers),n._details.show(!1,400)):n._details.hide()}}}),o(),n._cv.showLoading(!0);var u=t.service.get("configuration/usersgroups").done(function(e){n._allUsers=e.users,n._allGroups=e.groups,n._cv.showLoading(!1)})},this.onDeactivate=function(){n._details.remove()},this._showFolderDetails=function(e,n,r,i){t.dom.template("mollify-tmpl-config-admin-folderdetails",{folder:e}).appendTo(n),t.ui.process(n,["localize"]);var s=n.find(".mollify-config-admin-folderdetails-usersandgroups"),o=!1,u=!1,a=r.concat(i),f=function(){s.addClass("loading"),t.service.get("configuration/folders/"+e.id+"/users/").done(function(e){s.removeClass("loading"),u=e,o.table.set(e)})},l=function(){var n=t.helpers.extractValue(u,"id"),r=t.helpers.filter(a,function(e){return n.indexOf(e.id)<0});t.ui.dialogs.select({title:t.ui.texts.get("configAdminFolderAddUserTitle"),message:t.ui.texts.get("configAdminFolderAddUserMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",valueMapper:function(e,t){return e.is_group==1?"<i class='icon-user'></i><i class='icon-user'></i>":"<i class='icon-user'></i>"}},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUserDialogUsernameTitle")}],list:r,onSelect:function(n,r){t.service.post("configuration/folders/"+e.id+"/users/",t.helpers.extractValue(n,"id")).done(f)}})};o=new t.view.ConfigListView(s,{title:t.ui.texts.get("configAdminFolderUsersTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:l},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(n){t.service.post("configuration/folders/"+e.id+"/remove_users/",t.helpers.extractValue(n,"id")).done(f)}}],table:{id:"config-admin-folderusers",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"icon",title:"",valueMapper:function(e,t){return e.is_group==1?"<i class='icon-user'></i><i class='icon-user'></i>":"<i class='icon-user'></i>"}},{id:"id",title:t.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:t.ui.texts.get("configAdminUserDialogUsernameTitle")},{id:"remove",title:t.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(n,r){n=="remove"&&t.service.post("configuration/folders/"+e.id+"/remove_users/",[r.id]).done(f)}}}),f()},this._removeFolders=function(e){return t.service.del("configuration/folders",{ids:t.helpers.extractValue(e,"id")})},this._isValidPath=function(e){if(!e)return!1;if(e.indexOf("..")>=0)return!1;if(n._settings.published_folders_root)if(e.indexOf("/")===0||e.indexOf(":\\")===0)return!1;return!0},this.onAddEditFolder=function(e,r){var i=!1,s=!1,o=!1;t.ui.dialogs.custom({resizable:!0,initSize:[500,300],title:t.ui.texts.get(e?"configAdminFoldersFolderDialogEditTitle":"configAdminFoldersFolderDialogAddTitle"),content:t.dom.template("mollify-tmpl-config-admin-folderdialog",{folder:e}),buttons:[{id:"yes",title:t.ui.texts.get("dialogSave")},{id:"no",title:t.ui.texts.get("dialogCancel")}],"on-button":function(u,a){if(u.id=="no"){a.close();return}i.find(".control-group").removeClass("error");var l=s.val();l||s.closest(".control-group").addClass("error");var c=o.val(),h=n._isValidPath(c);h||o.closest(".control-group").addClass("error");if(!l){s.focus();return}if(!h){o.focus();return}var p={name:l,path:c},d=function(n){n.code==105&&(this.handled=!0,t.ui.dialogs.confirmation({title:t.ui.texts.get("configAdminFoldersFolderDialogAddTitle"),message:t.ui.texts.get("configAdminFoldersFolderDialogAddFolderDoesNotExist"),callback:function(){p.create=!0,e?t.service.put("configuration/folders/"+e.id,p).done(a.close).done(r):t.service.post("configuration/folders",p).done(a.close).done(r)}}))};e?t.service.put("configuration/folders/"+e.id,p).done(a.close).done(r).fail(d):t.service.post("configuration/folders",p).done(a.close).done(r).fail(d)},"on-show":function(t,n){i=n.find("#mollify-config-admin-folderdialog-content"),s=n.find("#nameField"),o=n.find("#pathField"),e&&(s.val(e.name),o.val(e.path)),s.focus(),t.center()}})}}}(window.jQuery,window.mollify),!function(e,t){"use strict";t.view.LoginView=function(){var n=this;n.init=function(e){t.dom.loadContentInto(e,t.templates.url("loginview.html"),n,["localize","bubble"])},n.onLoad=function(){t.features.hasFeature("lost_password")&&e("#mollify-login-forgot-password").show(),t.features.hasFeature("registration")&&t.plugins.exists("plugin-registration")&&e("#mollify-login-register").click(function(){t.plugins.get("plugin-registration").show()}).show(),e("#mollify-login-name, #mollify-login-password").bind("keypress",function(e){(e.keyCode||e.which)==13&&n.onLogin()}),e("#mollify-login-button").click(n.onLogin),e("#mollify-login-name").focus()},n.onRenderBubble=function(e,t){},n.onShowBubble=function(r,i){r==="mollify-login-forgot-password"&&(e("#mollify-login-forgot-button").click(function(){var r=e("#mollify-login-forgot-email").val();if(!r)return;i.hide(),n.wait=t.ui.dialogs.wait({target:"mollify-login-main"}),n.onResetPassword(r)}),e("#mollify-login-forgot-email").val("").focus())},n.onLogin=function(){var r=e("#mollify-login-name").val(),i=e("#mollify-login-password").val(),s=e("#mollify-login-remember-cb").is(":checked");if(!r||r.length<1){e("#mollify-login-name").focus();return}if(!i||i.length<1){e("#mollify-login-password").focus();return}n.wait=t.ui.dialogs.wait({target:"mollify-login-main"}),t.service.post("session/authenticate",{protocol_version:3,username:r,password:window.Base64.encode(i),remember:s}).done(function(e){t.events.dispatch("session/start",e)}).fail(function(e){e.code==107&&(this.handled=!0),n.showLoginError()})},n.onResetPassword=function(e){t.service.post("lostpassword",{email:e}).done(function(e){n.wait.close(),t.ui.dialogs.notification({message:t.ui.texts.get("resetPasswordPopupResetSuccess")})}).fail(function(e){this.handled=!0,n.wait.close(),t.ui.dialogs.info({message:t.ui.texts.get("resetPasswordPopupResetFailed")})})},n.showLoginError=function(){n.wait.close(),t.ui.dialogs.notification({message:t.ui.texts.get("loginDialogLoginFailedMessage")})}}}(window.jQuery,window.mollify),!function(e,t){"use strict";t.MollifyHTML5Uploader=function(){var n=this;return e(document).bind("drop dragover",function(e){return e.preventDefault(),!1}),this._getUploaderSettings=function(){return t.settings["html5-uploader"]||{}},this._initDropZoneEffects=function(e){e.bind("dragover",function(t){t.stopPropagation();var n=e,r=window.dropZoneTimeout;r?clearTimeout(r):n.addClass("in"),t.target===n[0]?n.addClass("hover"):n.removeClass("hover"),window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null,n.removeClass("in hover")},100)})},this.initWidget=function(r,i){var s=t.dom.template("mollify-tmpl-uploader-widget").appendTo(r);t.ui.handlers.localize(r);var o=i.dropElement||r,u=!1,a=i.handler,f=s.find("input").fileupload(e.extend({url:i.url,dataType:"json",dropZone:o,add:function(e,t){!u&&a.start?a.start(t.originalFiles,function(){t.submit()}):t.submit(),u=!0},progressall:function(e,t){if(!a.progress)return;var n=parseInt(t.loaded/t.total*100,10);a.progress(n,t.bitrate||!1)},done:function(e,t){a.finished&&a.finished(),u=!1},fail:function(e,t){a.failed&&a.failed(),u=!1}},n._getUploaderSettings()));o&&n._initDropZoneEffects(o)},{initUploadWidget:function(e,r){t.templates.load("mollify-uploader",t.templates.url("uploader.html")).done(function(){n.initWidget(e,r)})},initDragAndDropUploader:function(t){var r=t.container,i=e('<div style="width: 0px; height: 0px; overflow: hidden;"></div>').appendTo(r),s=e('<form enctype="multipart/form-data"></form>').appendTo(i),o=!1,u=e('<input type="file" class="mollify-mainview-uploader-input" name="uploader-html5[]" multiple="multiple"></input>').appendTo(s).fileupload(e.extend({url:"",dataType:"json",dropZone:t.dropElement,add:function(e,n){!o&&t.handler.start?t.handler.start(n.originalFiles,function(){n.submit()}):n.submit(),o=!0},progressall:function(e,n){if(!t.handler.progress)return;var r=parseInt(n.loaded/n.total*100,10);t.handler.progress(r,n.bitrate||!1)},done:function(e,n){t.handler.finished&&t.handler.finished(),o=!1},fail:function(e,n){t.handler.failed&&t.handler.failed(),o=!1}},n._getUploaderSettings())).fileupload("disable");return n._initDropZoneEffects(t.dropElement),{destroy:function(){u&&u.fileupload("destroy"),u=!1},setUrl:function(e){if(!u)return;if(!e){u.fileupload("disable");return}u.fileupload("enable").fileupload("option","url",e)}}}}}}(window.jQuery,window.mollify),!function(e,t){"use strict";t.plugin={},t.plugin.Core=function(){var n=this;return{id:"plugin-core",itemContextHandler:function(n,r,i){var s=n.id==n.root_id,o=!s&&(r.details.permission.toUpperCase()=="RW"||r.details.permission.toUpperCase()=="WD"),u=!s&&r.details.permission.toUpperCase()=="RW",a=!s&&(r.details.parent_permission.toUpperCase()=="RW"||r.details.parent_permission.toUpperCase()=="WD"),f=[];return n.is_file&&(f.push({"title-key":"actionDownloadItem",icon:"download",type:"primary",group:"download",callback:function(){t.ui.download(t.filesystem.getDownloadUrl(n))}}),f.push({title:"-"})),f.push({"title-key":"actionCopyItem",icon:"copy",callback:function(){return t.filesystem.copy(n)}}),a&&f.push({"title-key":"actionCopyItemHere",icon:"copy",callback:function(){return t.filesystem.copyHere(n)}}),o&&(f.push({"title-key":"actionMoveItem",icon:"mail-forward",callback:function(){return t.filesystem.move(n)}}),f.push({"title-key":"actionRenameItem",icon:"pencil",callback:function(){return t.filesystem.rename(n)}}),u&&f.push({"title-key":"actionDeleteItem",icon:"trash",callback:function(){var r=e.Deferred();return t.ui.dialogs.confirmation({title:n.is_file?t.ui.texts.get("deleteFileConfirmationDialogTitle"):t.ui.texts.get("deleteFolderConfirmationDialogTitle"),message:t.ui.texts.get(n.is_file?"confirmFileDeleteMessage":"confirmFolderDeleteMessage",[n.name]),callback:function(){e.when(t.filesystem.del(n)).then(r.resolve,r.reject)}}),r.promise()}})),{actions:f}},itemCollectionHandler:function(e){return{actions:[{"title-key":"actionCopyMultiple",icon:"copy",callback:function(){return t.filesystem.copy(e)}},{"title-key":"actionMoveMultiple",icon:"mail-forward",callback:function(){return t.filesystem.move(e)}},{"title-key":"actionDeleteMultiple",icon:"trash",callback:function(){return t.filesystem.del(e)}}]}}}},t.plugin.ItemDetailsPlugin=function(e,n){var r=this;return r.formatters={},r.typeConfs=!1,this.initialize=function(){r.fileSizeFormatter=new t.ui.formatters.ByteSize(new t.ui.formatters.Number(2,!1,t.ui.texts.get("decimalSeparator"))),r.timestampFormatter=new t.ui.formatters.Timestamp(t.ui.texts.get("shortDateTimeFormat"));if(e){r.typeConfs={};for(var n in e){var i=n.split(","),s=e[n];for(var o=0;o<i.length;o++){var u=i[o].trim();u.length>0&&(r.typeConfs[u]=s)}}}},this.getApplicableSpec=function(e){var t=e.is_file&&e.extension?e.extension.toLowerCase().trim():"";if(t.length===0||!r.typeConfs[t]){t=e.is_file?"[file]":"[folder]";if(!r.typeConfs[t])return r.typeConfs["*"]}return r.typeConfs[t]},this.renderItemContextDetails=function(e,n,i,s){i.addClass("loading"),t.templates.load("itemdetails-content",t.helpers.noncachedUrl(t.plugins.url("ItemDetails","content.html"))).done(function(){i.removeClass("loading"),r.renderItemDetails(e,n,{element:i.empty(),data:s})})},this.renderItemDetails=function(e,n,i){var s=r.getApplicableSpec(n),o=r.getGroups(s,i.data),u=[];for(var a=0,f=o.length;a<f;a++){var l=o[a];u.push({key:l,title:r.getGroupTitle(l),rows:r.getGroupRows(l,s,i.data)})}t.dom.template("itemdetails-template",{groups:u}).appendTo(i.element)},this.getGroups=function(e,t){var n=[];for(var i in e){var s=e[i],o=t[i];if(!o)continue;var u="file";if(i=="exif"||r.formatters[i])u=i;n.indexOf(u)<0&&n.push(u)}return n},this.getGroupTitle=function(e){if(r.formatters[e]){var n=r.formatters[e];if(n.groupTitle)return n.groupTitle;if(n["group-title-key"])return t.ui.texts.get(n["group-title-key"])}return e=="file"?t.ui.texts.get("fileItemDetailsGroupFile"):e=="exif"?t.ui.texts.get("fileItemDetailsGroupExif"):""},this.getGroupRows=function(e,t,n){if(r.formatters[e])return r.formatters[e].getGroupRows(t[e],n[e]);if(e=="exif")return r.getExifRows(t[e],n[e]);var i=[];for(var s in t){if(s=="exif"||r.formatters[s])continue;var o=t[s],u=n[s];if(!u)continue;i.push({title:r.getFileRowTitle(s,t[s]),value:r.formatFileData(s,u)})}return i},this.getFileRowTitle=function(e,n){return n.title?n.title:n["title-key"]?t.ui.texts.get(n["title-key"]):e=="name"?t.ui.texts.get("fileItemContextDataName"):e=="size"?t.ui.texts.get("fileItemContextDataSize"):e=="path"?t.ui.texts.get("fileItemContextDataPath"):e=="extension"?t.ui.texts.get("fileItemContextDataExtension"):e=="last-modified"?t.ui.texts.get("fileItemContextDataLastModified"):e=="image-size"?t.ui.texts.get("fileItemContextDataImageSize"):e},this.formatFileData=function(e,n){if(e=="size")return r.fileSizeFormatter.format(n);if(e=="last-modified")return r.timestampFormatter.format(t.helpers.parseInternalTime(n));if(e=="image-size")return t.ui.texts.get("fileItemContextDataImageSizePixels"
,[n]);if(r.specs[e]){var i=r.specs[e];if(i.formatter)return i.formatter(n)}return n},this.getExifRows=function(e,t){var n=[];for(var i in t){var s="",o=!0,u=0;for(var a in t[i]){var f=r.formatExifValue(i,a,t[i][a]);if(!f)continue;s+='<tr id="exif-row-'+i+"-"+a+'" class="'+(o?"exif-row-section-first":"exif-row")+'"><td class="exif-key">'+a+'</td><td class="exif-value">'+f+"</td></tr>",o=!1,u++}u>0&&n.push({title:i,value:'<table class="exif-section-'+i+'">'+s+"</table>"})}return n},this.formatExifValue=function(e,t,n){return e=="FILE"&&t=="SectionsFound"?!1:n},{id:"plugin-itemdetails",initialize:r.initialize,itemContextRequestData:function(e){if(!r.typeConfs)return!1;var t=r.getApplicableSpec(e);if(!t)return!1;var n=[];for(var i in t)n.push(i);return n},itemContextHandler:function(e,t,n){if(!n||!r.typeConfs)return!1;var i=r.getApplicableSpec(e);return i?{details:{"title-key":"pluginItemDetailsContextTitle","on-render":function(t,i){r.renderItemContextDetails(t,e,i,n)}}}:!1}}},t.plugin.ItemCollectionPlugin=function(){var n=this;return this.initialize=function(){},this.onStore=function(r){var i=e.Deferred();return t.ui.dialogs.input({title:t.ui.texts.get("pluginItemCollectionStoreDialogTitle"),message:t.ui.texts.get("pluginItemCollectionStoreDialogMessage"),defaultValue:"",yesTitle:t.ui.texts.get("pluginItemCollectionStoreDialogAction"),noTitle:t.ui.texts.get("dialogCancel"),handler:{isAcceptable:function(e){return!!e&&e.length>0},onInput:function(t){e.when(n._onStore(r,t)).then(i.resolve,i.reject)}}}),i.promise()},this._onStore=function(e,r){return t.service.post("itemcollections",{items:e,name:r}).done(function(e){n._updateNavBar(e)})},this.onAddItems=function(e,n){return t.service.post("itemcollections/"+e.id,{items:window.isArray(n)?n:[n]})},this._removeCollectionItem=function(e,n){return t.service.del("itemcollections/"+e.id+"/items",{items:window.isArray(n)?n:[n]})},this._showCollection=function(e){n._fileView.changeToFolder("ic/"+e.id)},this.editCollection=function(e,r){t.service.get("itemcollections/"+e.id).done(function(i){t.ui.dialogs.tableView({title:t.ui.texts.get("pluginItemCollectionsEditDialogTitle",e.name),buttons:[{id:"close",title:t.ui.texts.get("dialogClose")},{id:"remove",title:t.ui.texts.get("pluginItemCollectionsEditDialogRemove"),type:"secondary",cls:"btn-danger secondary"}],onButton:function(t,i){i.close(),t.id=="remove"&&n.removeCollection(e),r(t.id=="remove")},table:{key:"item_id",columns:[{id:"icon",title:"",renderer:function(e,t,n){n.html(e.is_file?'<i class="icon-file"></i>':'<i class="icon-folder-close-alt"></i>')}},{id:"name",title:t.ui.texts.get("fileListColumnTitleName")},{id:"remove",title:"",type:"action",content:'<i class="icon-trash"></i>'}]},onTableRowAction:function(t,r,i,s){i=="remove"&&n._removeCollectionItem(e,s).done(function(){r.remove(s)})},onRender:function(e,t,n){n.set(i.items),t.removeClass("loading")}})})},this._updateNavBar=function(t){n._list=t;var r=[],i={};e.each(t,function(e,t){i[t.id]=t,r.push({title:t.name,obj:t,callback:function(){n._showCollection(t)}})}),n._collectionsNav.update(r);var s=n._fileView.getCurrentFolder();s.type=="ic"&&n._collectionsNav.setActive(i[s.id])},this.removeCollection=function(e){return t.service.del("itemcollections/"+e.id).done(n._updateNavBar)},this._onShareNavItem=function(e){if(!t.plugins.exists("plugin-share"))return;t.plugins.get("plugin-share").openShares({id:"ic_"+e.id,name:e.name,shareTitle:t.ui.texts.get("pluginItemCollectionShareTitle")})},this._getItemActions=function(e){var r=[{"title-key":"pluginItemCollectionsNavEdit",callback:function(){n.editCollection(e,function(t){var r=n._fileView.getCurrentFolder();if(r.type!="ic"||r.id!=e.id)return;t?n._fileView.openInitialFolder():n._fileView.refresh()})}},{"title-key":"pluginItemCollectionsNavRemove",callback:function(){n._fileView.openInitialFolder(),n.removeCollection(e)}}];return t.plugins.exists("plugin-share")&&r.push({"title-key":"pluginItemCollectionsNavShare",callback:function(){n._onShareNavItem(e)}}),r},this._onFileViewInit=function(r){n._fileView=r,n._fileView.addCustomFolderType("ic",{onSelectFolder:function(r){var i=e.Deferred();return t.service.post("itemcollections/"+r+"/data",{rq_data:n._fileView.getDataRequest()}).done(function(e){n._collectionsNav.setActive(e.ic);var t={type:"ic",id:e.ic.id,name:e.ic.name},r={items:e.ic.items,ic:e.ic,data:e.data};i.resolve(t,r)}),i.promise()},onFolderDeselect:function(e){n._collectionsNav.setActive(!1)},onRenderFolderView:function(r,i,s,o){t.dom.template("mollify-tmpl-fileview-header-custom",{folder:r}).appendTo(s);var u={title:function(){return this.data.title?this.data.title:t.ui.texts.get(this.data["title-key"])}},a=e("#mollify-fileview-folder-actions"),f=t.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-cog",dropdown:!0},u).appendTo(a);t.ui.controls.dropdown({element:f,items:n._getItemActions(i.ic),hideDelay:0,style:"submenu"}),n._fileView.addCommonFileviewActions(a)}})},this._onFileViewActivate=function(e,r){n._collectionsNav=r.addNavBar({title:t.ui.texts.get("pluginItemCollectionsNavTitle"),classes:"ic-navbar-item",items:[],dropdown:{items:n._getItemActions},onRender:t.ui.draganddrop?function(e,r,i){t.ui.draganddrop.enableDrop(r,{canDrop:function(e,t,n){return!n||n.type!="filesystemitem"?!1:!0},dropType:function(e,t,n){return!n||n.type!="filesystemitem"?!1:"copy"},onDrop:function(e,t,r){if(!r||r.type!="filesystemitem")return;var s=r.payload,o=i(e);n.onAddItems(o,s)}})}:!1}),t.service.get("itemcollections").done(n._updateNavBar)},{id:"plugin-itemcollection",initialize:n.initialize,itemCollectionHandler:function(e){return{actions:[{"title-key":"pluginItemCollectionStore",callback:function(){return n.onStore(e)}}]}},fileViewHandler:{onInit:n._onFileViewInit,onActivate:n._onFileViewActivate}}},t.plugin.ArchiverPlugin=function(){var n=this;return this.initialize=function(){},this.onCompress=function(r,i){if(!r)return;var s="",o=!1,u=t.helpers.arrayize(r);u.length==1&&(o=r[0]);var a=e.Deferred(),f=function(r){o&&(s=o.name+".zip"),t.ui.dialogs.input({title:t.ui.texts.get("pluginArchiverCompressDialogTitle"),message:t.ui.texts.get("pluginArchiverCompressDialogMessage"),defaultValue:s,yesTitle:t.ui.texts.get("pluginArchiverCompressDialogAction"),noTitle:t.ui.texts.get("dialogCancel"),handler:{isAcceptable:function(e){return!!e&&e.length>0&&(!o||e!=o.name)},onInput:function(t){e.when(n._onCompress(u,r,t)).then(a.resolve,a.reject)}}})};return i?f(i):t.ui.dialogs.folderSelector({title:t.ui.texts.get("pluginArchiverCompressDialogTitle"),message:t.ui.texts.get("pluginArchiverCompressSelectFolderDialogMessage"),actionTitle:t.ui.texts.get("ok"),handler:{onSelect:function(e){f(e)},canSelect:function(e){return!0}}}),a.promise()},this.onDownloadCompressed=function(e){return t.service.post("archiver/download",{items:e}).done(function(e){t.ui.download(t.service.url("archiver/download/"+e.id,!0))})},this._onCompress=function(e,n,r){return t.service.post("archiver/compress",{items:e,folder:n,name:r}).done(function(i){t.events.dispatch("archiver/compress",{items:e,folder:n,name:r}),t.events.dispatch("filesystem/update",{folder:n})})},this._onExtract=function(e,n){return t.service.post("archiver/extract",{item:e,folder:n}).done(function(r){t.events.dispatch("archiver/extract",{item:e,folder:n}),t.events.dispatch("filesystem/update",{folder:n})})},this._isArchive=function(e){if(!e.is_file)return!1;var t=e.extension.toLowerCase();return t=="zip"},{id:"plugin-archiver",initialize:n.initialize,getDownloadCompressedUrl:function(e){var n=!1;return window.isArray(e)?e.length==1&&(n=e[0]):n=e,n?t.service.url("archiver/download?item="+n.id,!0):!1},itemContextHandler:function(e,t,r){var i=e.id==e.root_id,s=!i&&(t.details.permission.toUpperCase()=="RW"||t.details.permission.toUpperCase()=="WD"),o=!i&&(t.details.parent_permission.toUpperCase()=="RW"||t.details.parent_permission.toUpperCase()=="WD"),u=!i&&t.folder_permission&&(t.folder_permission.toUpperCase()=="RW"||t.folder_permission.toUpperCase()=="WD");if(o&&n._isArchive(e))return{actions:[{"title-key":"pluginArchiverExtract",callback:function(){return n._onExtract(e)}}]};var a=[{"title-key":"pluginArchiverDownloadCompressed",icon:"archive",type:"primary",group:"download",callback:function(){n.onDownloadCompressed([e])}}];return t.folder&&u&&a.push({"title-key":"pluginArchiverCompress",icon:"archive",callback:function(){return n.onCompress(e,t.folder)}}),{actions:a}},itemCollectionHandler:function(e,t){return{actions:[{"title-key":"pluginArchiverCompress",icon:"archive",callback:function(){return n.onCompress(e)}},{"title-key":"pluginArchiverDownloadCompressed",icon:"archive",type:"primary",group:"download",callback:function(){return n.onDownloadCompressed(e)}}]}}}},t.plugin.FileViewerEditorPlugin=function(){var n=this;return this.initialize=function(){},this.onEdit=function(n,r){t.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:t.ui.texts.get("fileViewerEditorViewEditDialogTitle"),content:'<div class="fileviewereditor-editor-content"></div>',buttons:[{id:"yes",title:t.ui.texts.get("dialogSave")},{id:"no",title:t.ui.texts.get("dialogCancel")}],"on-button":function(e,t){if(e.id=="no"){t.close();return}document.getElementById("editor-frame").contentWindow.onEditorSave(function(){t.close()},function(e,n){return t.close(),!0})},"on-show":function(t,n){var i=n.find(".fileviewereditor-editor-content"),s=e('<iframe id="editor-frame" width="100%" height:"100%" style="width:100%;height:100%;border: none;overflow: none;" />').attr("src",r.embedded);i.removeClass("loading").append(s),t.center()}})},this.onView=function(r,i,s){var o={},u=[{embedded:s.view.embedded,full:s.view.full,edit:!!s.edit,item:r}],a=u[0],f=!1;a.init=!0;var l=!1,c,h,p=!1,d,v,m=function(){d=e(window).width()-100,v=e(window).height()-100,h.css({"max-width":d+"px","max-height":v+"px"}),p&&p.css({"max-width":d+"px","max-height":v+"px"}),c.lightbox("center")};e(window).resize(m);var g=function(t){var n=t.item.id;l=t;if(o[n])return;e.ajax({type:"GET",url:t.embedded}).done(function(t){o[n]=!0,p=e("#mollify-fileviewereditor-viewer-item-"+n);var r=p.find(".mollify-fileviewereditor-viewer-item-content");r.removeClass("loading").html(t.result.html);if(t.result.size){var i=t.result.size.split(";");e("#"+t.result.resized_element_id).css({width:i[0]+"px",height:i[1]+"px"})}var s=r.find("img:first");s.length>0?s.one("load",function(){var e=s.width();!t.result.size&&e>0&&s.css({width:e+"px",height:s.height()+"px"}),m()}):m(),f||(c.lightbox("show"),f=!0)})},y=t.dom.template("mollify-tmpl-fileviewereditor-popup",{items:u},{content:function(e){return e.content}}).appendTo(e("body")),b=function(){y.remove()};c=y.lightbox({backdrop:!0,resizeToFit:!1,show:!1,onHide:b}),t.ui.process(c,["localize"]),c.find("button.close").click(function(){c.lightbox("hide")}),h=c.find(".carousel-inner");var w=y.find(".carousel").carousel({interval:!1}).on("slid",function(){var e=y.find(".mollify-fileviewereditor-viewer-item.active");g(e.tmplItem().data)});w.find(".carousel-control").click(function(){e(this).hasClass("left")?w.carousel("prev"):w.carousel("next")});var E=w.find(".mollify-fileviewereditor-viewer-tools");E.find(".mollify-fileviewereditor-viewer-item-viewinnewwindow").click(function(){c.lightbox("hide"),t.ui.window.open(l.full)}),E.find(".mollify-fileviewereditor-viewer-item-edit").click(function(){c.lightbox("hide"),n.onEdit(r,s.edit)}),g(a)},{id:"plugin-fileviewereditor",initialize:n.initialize,itemContextHandler:function(t,r,i){if(!i)return!1;var s=!!i.preview,o=!!i.view,u=!!i.edit,a={details:!1,actions:[]};return s&&(a.details={"title-key":"pluginFileViewerEditorPreview","on-render":function(t,n){n.empty().addClass("loading"),e.ajax({type:"GET",url:i.preview}).done(function(e){n.removeClass("loading").html(e.result.html)})}}),o&&a.actions.push({id:"pluginFileViewerEditorView","title-key":"pluginFileViewerEditorView",type:"primary",callback:function(){n.onView(t,[],i)}}),u&&a.actions.push({id:"pluginFileViewerEditorView","title-key":"pluginFileViewerEditorEdit",type:"primary",callback:function(){n.onEdit(t,i.edit)}}),a}}},t.plugin.CommentPlugin=function(){var n=this;return this.initialize=function(){n._timestampFormatter=new t.ui.formatters.Timestamp(t.ui.texts.get("shortDateTimeFormat")),t.dom.importCss(t.plugins.url("Comment","style.css"))},this.getListCellContent=function(e,t){if(!e.id||e.id.length===0||!t||!t["plugin-comment-count"])return"";var n=t["plugin-comment-count"];return n[e.id]?"<div id='item-comment-count-"+e.id+"' class='filelist-item-comment-count'>"+n[e.id]+"</div>":"<div id='item-comment-count-"+e.id+"' class='filelist-item-comment-count-none'></div>"},this.renderItemContextDetails=function(e,r,i,s){i.addClass("loading"),t.templates.load("comments-content",t.helpers.noncachedUrl(t.plugins.url("Comment","content.html"))).done(function(){i.removeClass("loading"),s.count===0?n.renderItemContextComments(e,r,[],{element:i.empty(),contentTemplate:"comments-template"}):n.loadComments(r,function(t,r){n.renderItemContextComments(e,t,r,{element:i.empty(),contentTemplate:"comments-template"})})})},this.renderItemContextComments=function(r,i,s,o){t.dom.template(o.contentTemplate,i).appendTo(o.element),e("#comments-dialog-add").click(function(){var t=e("#comments-dialog-add-text").val();if(!t||t.length===0)return;n.onAddComment(i,t,r.close)}),n.updateComments(e("#comments-list"),i,s)},this.showCommentsBubble=function(r,i){var s=t.ui.controls.dynamicBubble({element:i,title:r.name,container:e("#mollify-filelist-main-items")});t.templates.load("comments-content",t.helpers.noncachedUrl(t.plugins.url("Comment","content.html"))).done(function(){s.content(t.dom.template("comments-template",r)),e("#comments-dialog-add").click(function(){var t=e("#comments-dialog-add-text").val();if(!t||t.length===0)return;n.onAddComment(r,t,s.close)}),n.loadComments(r,function(t,r){n.updateComments(e("#comments-list"),t,r)})})},this.loadComments=function(e,r){t.service.get("comment/"+e.id).done(function(t){r(e,n.processComments(t))})},this.processComments=function(e){var r=t.session.user_id,i=t.session.admin;for(var s=0,o=e.length;s<o;s++)e[s].time=n._timestampFormatter.format(t.helpers.parseInternalTime(e[s].time)),e[s].comment=e[s].comment.replace(new RegExp("\n","g"),"<br/>"),e[s].remove=i||r==e[s].user_id;return e},this.onAddComment=function(e,r,i){t.service.post("comment/"+e.id,{comment:r}).done(function(t){n.updateCommentCount(e,t.count),i&&i()})},this.onRemoveComment=function(e,r,i){t.service.del("comment/"+r.id+"/"+i).done(function(t){n.updateCommentCount(r,t.length),n.updateComments(e,r,n.processComments(t))})},this.updateCommentCount=function(e,t){var n=document.getElementById("item-comment-count-"+e.id);if(!n)return;t<1?(n.innerHTML="",n.setAttribute("class","filelist-item-comment-count-none")):(n.innerHTML=t,n.setAttribute("class","filelist-item-comment-count"))},this.updateComments=function(r,i,s){r.removeClass("loading");if(s.length===0){r.html("<span class='message'>"+t.ui.texts.get("commentsDialogNoComments")+"</span>");return}t.dom.template("comment-template",s).appendTo(r.empty()),r.find(".comment-content").hover(function(){e(this).addClass("hover")},function(){e(this).removeClass("hover")}),r.find(".comment-remove-action").click(function(t){t.preventDefault();var s=e(this).tmplItem().data;n.onRemoveComment(r,i,s.id)})},{id:"plugin-comment",initialize:n.initialize,fileViewHandler:{filelistColumns:function(){return[{id:"comment-count","request-id":"plugin-comment-count","title-key":"",width:50,content:n.getListCellContent,request:function(e){return{}},"on-click":function(t){n.showCommentsBubble(t,e("#item-comment-count-"+t.id))}}]}},itemContextHandler:function(e,t,r){return{details:{"title-key":"pluginCommentContextTitle","on-render":function(t,i){n.renderItemContextDetails(t,e,i,r)}}}}}},t.plugin.PermissionsPlugin=function(){var n=this;return this.initialize=function(){n.permissionOptions=[{title:t.ui.texts.get("pluginPermissionsValueRW"),value:"rw"},{title:t.ui.texts.get("pluginPermissionsValueWD"),value:"wd"},{title:t.ui.texts.get("pluginPermissionsValueRO"),value:"ro"},{title:t.ui.texts.get("pluginPermissionsValueNO"),value:"no"}],n.permissionOptionsByKey=t.helpers.mapByKey(n.permissionOptions,"value")},n.onOpenPermissions=function(r){var i={"new":[],modified:[],removed:[]},s=!1;t.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:t.ui.texts.get("pluginPermissionsEditDialogTitle"),content:t.dom.template("mollify-tmpl-permission-editor",{item:r}),buttons:[{id:"yes",title:t.ui.texts.get("dialogSave")},{id:"no",title:t.ui.texts.get("dialogCancel")}],"on-button":function(e,n){if(e.id=="no"){n.close();return}if(i["new"].length===0&&i.modified.length===0&&i.removed.length===0)return;s.addClass("loading"),t.service.put("filesystem/permissions",i).done(n.close).fail(n.close)},"on-show":function(t,o){s=o.find("#mollify-pluginpermissions-editor-content"),e("#mollify-pluginpermissions-editor-change-item").click(function(e){return e.preventDefault(),!1}),t.center(),n.loadPermissions(r,function(e,t){s.removeClass("loading"),n.initEditor(r,e,t,i)}).fail(t.close)}})},this.processUserData=function(e){var t={users:[],groups:[],usersById:{}};for(var n=0,r=e.length;n<r;n++){var i=e[n];i.is_group=="0"?(t.users.push(i),t.usersById[i.id]=i):(t.groups.push(i),t.usersById[i.id]=i)}return t},this.loadPermissions=function(e,r){return t.service.get("filesystem/"+e.id+"/permissions?u=1").done(function(e){r(e.permissions,n.processUserData(e.users))})},this.initEditor=function(r,i,s,o){var u,a=function(e){return s.usersById[e].is_group!="0"},f=function(e,t){var n=u.findByKey(e.id);if(n)n.isnew||o.modified.push(n),n.permission=t,u.update(n);else{for(var i=0,s=o.removed.length;i<s;i++){var a=o.removed[i];if(a.user_id==e.id){o.removed.remove(i),o.modified.push(a),a.permission=t,u.add(a);return}}var f={user_id:e.id,item_id:r.id,permission:t,isnew:!0};o["new"].push(f),u.add(f)}},l=function(e){e.isnew||o.removed.push(e)},c=function(e){e.isnew||o.modified.push(e)};u=t.ui.controls.table("mollify-pluginpermissions-editor-permission-list",{key:"user_id",onRow:function(e,t){a(t.user_id)&&e.addClass("group")},columns:[{id:"user_id",title:t.ui.texts.get("pluginPermissionsEditColUser"),renderer:function(e,t,n){n.html(s.usersById[t].name).addClass("user")}},{id:"permission",title:t.ui.texts.get("pluginPermissionsEditColPermission"),type:"select",options:n.permissionOptions,valueMapper:function(e,t){return n.permissionOptionsByKey[t]},onChange:function(e,t){e.permission=t.value,c(e)},cellClass:"permission"},{id:"remove",title:"",type:"action",content:t.dom.template("mollify-tmpl-permission-editor-listremove").html()}],onRowAction:function(e,t){l(t),u.remove(t)}}),u.add(i);var h=t.ui.controls.select("mollify-pluginpermissions-editor-new-user",{none:{title:t.ui.texts.get("pluginPermissionsEditNoUser")},title:"name",onCreate:function(e,t){a(t.id)&&e.addClass("group")}});h.add(s.users),h.add(s.groups);var p=t.ui.controls.select("mollify-pluginpermissions-editor-new-permission",{values:n.permissionOptions,none:t.ui.texts.get("pluginPermissionsEditNoPermission"),title:"title"}),d=function(){h.select(!1),p.select(!1)};d(),e("#mollify-pluginpermissions-editor-new-add").click(function(){var e=h.selected();if(!e)return;var t=p.selected();if(!t)return;f(e,t.value),d()})},this.renderItemContextDetails=function(r,i,s){t.dom.template("mollify-tmpl-permission-context").appendTo(s),t.ui.process(s,["localize"]),n.loadPermissions(i,function(s,o){e("#mollify-pluginpermissions-context-content").removeClass("loading");var u=t.ui.controls.table("mollify-pluginpermissions-context-permission-list",{key:"user_id",columns:[{id:"user_id",title:t.ui.texts.get("pluginPermissionsEditColUser"),renderer:function(e,t,n){n.html(o.usersById[t].name).addClass("user")}},{id:"permission",title:t.ui.texts.get("pluginPermissionsEditColPermission"),renderer:function(e,t,r){r.html(n.permissionOptionsByKey[t].title)}}]});u.add(s),e("#mollify-pluginpermissions-context-edit").click(function(){r.close(),n.onOpenPermissions(i)})}).fail(function(e){r.close()})},{id:"plugin-permissions",initialize:n.initialize,itemContextHandler:function(e,r,i){return t.session.admin?{details:{"title-key":"pluginPermissionsContextTitle","on-render":function(t,r){n.renderItemContextDetails(t,e,r)}},actions:[{id:"pluginPermissions","title-key":"pluginPermissionsAction",callback:function(){n.onOpenPermissions(e)}}]}:!1}}},t.plugin.DropboxPlugin=function(){var n=this;return n.w=0,n.$dbE=!1,n.items=[],n.itemsByKey={},this.initialize=function(){n.itemContext=new t.ui.itemContext,t.events.addEventHandler(function(e){e.type=="filesystem/delete"&&n.onRemoveItems(t.helpers.extractValue(e.payload.items,"id"))})},this.onFileViewActivate=function(r){t.dom.template("mollify-tmpl-mainview-dropbox").appendTo(r),e("#mollify-dropbox-handle").click(function(){n.openDropbox()}),n.$dbE=e("#mollify-dropbox"),n.w=e("#mollify-dropbox-content").outerWidth();var i=function(){var t=e("#mollify-mainview-header").height();n.$dbE.css("top",t+"px").height(e(window).height()-t)};e(window).resize(i),i();if(t.ui.draganddrop){var s={canDrop:function(e,t,r){if(!r||r.type!="filesystemitem")return!1;var i=r.payload;return n.items.indexOf(i)<0},dropType:function(e,t,n){return!n||n.type!="filesystemitem"?!1:"copy"},onDrop:function(e,t,r){if(!r||r.type!="filesystemitem")return;var i=r.payload;n.onAddItem(i)}};t.ui.draganddrop.enableDrop(e("#mollify-dropbox-list"),s),t.ui.draganddrop.enableDrop(e("#mollify-dropbox-handle"),s)}var o=t.ui.controls.dropdown({element:e("#mollify-dropbox-actions"),container:e("body"),hideDelay:0,dynamic:!0,onShow:function(e,t){n.getActions(function(t){if(!t){e.hide();return}e.items(t)})},onItem:function(e,t){t?t.done(n.emptyDropbox):n.emptyDropbox()},onBlur:function(e){}});n._updateButton(),n.openDropbox(!1)},this.onFileViewDeactivate=function(){e("#mollify-dropbox").remove()},this.getActions=function(e){if(n.items.length===0){e([]);return}var r=t.helpers.getPluginActions(t.plugins.getItemCollectionPlugins(n.items,{src:"dropbox"}));r.push({title:"-"}),r.push({"title-key":"dropboxEmpty"}),e(t.helpers.cleanupActions(r))},this.openDropbox=function(e){var t=n.$dbE.hasClass("opened");if(window.def(e)){if(e==t)return}else e=!t;e?n.$dbE.addClass("opened").removeClass("closed").animate({width:n.w+""},300):n.$dbE.removeClass("opened").addClass("closed").animate({width:"0"},300)},this.emptyDropbox=function(){n.items=[],n.itemsByKey={},n.refreshList()},this.onAddItem=function(t){n.openDropbox(!0);var r=t;window.isArray(t)||(r=[t]),e.each(r,function(e,t){if(n.items.indexOf(t)>=0)return;n.items.push(t),n.itemsByKey[t.id]=t}),n.refreshList(),n._updateButton()},this.onRemoveItem=function(e){n.items.remove(e),delete n.itemsByKey[e.id],n.refreshList(),n._updateButton()},this.onRemoveItems=function(t){var r=0;e.each(t,function(e,t){var i=n.itemsByKey[t];if(!i)return;n.items.remove(i),delete n.itemsByKey[t],r++}),r>0&&(n.refreshList(),n._updateButton())},this.refreshList=function(){e("#mollify-dropbox-list").empty().append(t.dom.template("mollify-tmpl-mainview-dropbox-item",n.items));var r=e("#mollify-dropbox-list .mollify-dropbox-list-item");r.click(function(r){r.preventDefault(),r.stopPropagation();var i=e(this),s=i.tmplItem().data;return i.tooltip("hide"),n.itemContext.open({item:s,element:i,container:t.App.getElement(),viewport:t.App.getElement()}),!1}).each(function(){var n=e(this),r=n.tmplItem().data;n.tooltip({placement:"bottom",html:!0,title:t.filesystem.rootsById[r.root_id].name+(r.path.length>0?":&nbsp;"+r.path:""),trigger:"hover"})}),t.ui.draganddrop&&t.ui.draganddrop.enableDrag(r,{onDragStart:function(e,t){var n=e.tmplItem().data;return{type:"filesystemitem",payload:n}}}),e("#mollify-dropbox-list .mollify-dropbox-list-item > a.item-remove").click(function(){t.ui.hideActivePopup();var r=e(this);n.onRemoveItem(r.tmplItem().data)})},this._updateButton=function(){var t=e("#mollify-dropbox-actions > button");n.items.length>0?t.removeClass("disabled"):t.addClass("disabled")},{id:"plugin-dropbox",initialize:n.initialize,fileViewHandler:{onActivate:n.onFileViewActivate,onDeactivate:n.onFileViewDeactivate},itemContextHandler:function(e,t,r){return{actions:[{id:"pluginDropbox","title-key":"pluginDropboxAddTo",callback:function(){n.onAddItem(e),n.openDropbox(!0)}}]}},itemCollectionHandler:function(e,t){return t&&t.src=="dropbox"?!1:{actions:[{"title-key":"pluginDropboxAddTo",callback:function(){return n.onAddItem(e)}}]}}}},t.plugin.SharePlugin=function(){var n=this;return this.initialize=function(){n._timestampFormatter=new t.ui.formatters.Timestamp(t.ui.texts.get("shortDateTimeFormat")),t.App.registerView("share",{getView:function(r,i){if(r.length!=2)return!1;var s=e.Deferred(),o=r[1];return t.service.get("public/"+o+"/info/").done(function(e){if(!e||!e.type||["download","upload","prepared_download"].indexOf(e.type)<0){s.resolve(new t.ui.FullErrorView(t.ui.texts.get("shareViewInvalidRequest")));return}if(e.restriction=="private"){if(!t.session||!t.session.authenticated){s.resolve(!1);return}}else if(e.restriction=="pw"&&!e.auth){s.resolve(new n.ShareAccessPasswordView(o,e));return}s.resolve(n._getShareView(o,e))}).fail(function(){s.resolve(new t.ui.FullErrorView(t.ui.texts.get("shareViewInvalidRequest")))}),s.promise()}})},this._getShareView=function(e,r){var i=t.service.url("public/"+e,!0),s={get:function(e,n){var r=i;return e&&(r+=e),n&&(r=t.helpers.urlWithParam(r,n)),t.helpers.noncachedUrl(r)}};return r.type=="download"?new n.ShareDownloadView(e,s,r.name):r.type=="prepared_download"?new n.SharePreparedDownloadView(e,s,r.name):new n.ShareUploadView(e,s,r.name)},this.ShareAccessPasswordView=function(r,i){var s=this;this.init=function(n){s._$c=n,t.dom.loadContentInto(n,t.plugins.url("Share","public_share_access_password.html"),function(){e("#mollify-share-access-button").click(s._onAccess),e("#mollify-share-access-password").focus(),e("#mollify-share-access-password").bind("keypress",function(e){(e.keyCode||e.which)==13&&s._onAccess()})},["localize"])},this._onAccess=function(){var o=e("#mollify-share-access-password").val();if(!o||o.length===0)return;var u=window.Base64.encode(o);t.service.post("public/"+r+"/key/",{key:u}).done(function(o){if(!o.result){t.ui.dialogs.notification({message:t.ui.texts.get("shareAccessPasswordFailed")}),e("#mollify-share-access-password").focus();return}n._getShareView(r,i,u).init(s._$c)})}},this.ShareDownloadView=function(n,r,i){var s=this;this.init=function(n){t.dom.loadContentInto(n,t.plugins.url("Share","public_share_download.html"),function(){e("#mollify-share-title").text(t.ui.texts.get("shareViewDownloadTitle",i)),setTimeout(function(){t.ui.download(r.get())},1e3)},["localize"])}},this.SharePreparedDownloadView=function(n,r,i){var s=this;this.init=function(n){t.dom.loadContentInto(n,t.plugins.url("Share","public_share_prepared_download.html"),function(){e("#mollify-share-download-prepare").text(t.ui.texts.get("shareViewPreparedDownloadPreparingTitle",i)),e("#mollify-share-download").text(t.ui.texts.get("shareViewPreparedDownloadDownloadingTitle",i)),e("#mollify-share-download-error").text(t.ui.texts.get("shareViewPreparedDownloadErrorTitle",i)),t.service.get(r.get("/prepare")).done(function(n){e("#mollify-share-download-prepare").hide(),e("#mollify-share-download").show(),t.ui.download(r.get(!1,"key="+n.key))}).fail(function(){this.handled=!0,e("#mollify-share-download-prepare").hide(),e("#mollify-share-download-error").show()})},["localize"])}},this.ShareUploadView=function(r,i,s){var o=this;this.init=function(r){var a=new t.ui.formatters.Number(1,t.ui.texts.get("dataRateKbps"),t.ui.texts.get("decimalSeparator"));t.dom.loadContentInto(r,t.plugins.url("Share","public_share_upload.html"),function(){e("#mollify-share-title").text(t.ui.texts.get("shareViewUploadTitle",s)),o._uploadProgress=new n.PublicUploaderProgress(e("#mollify-share-public-upload-progress")),t.ui.uploader.initUploadWidget(e("#mollify-share-public-uploader"),{url:i.get(!1,"format=binary"),dropElement:e("#mollify-share-public"),handler:{start:function(e,n){o._uploadProgress.start(t.ui.texts.get(e.length>1?"mainviewUploadProgressManyMessage":"mainviewUploadProgressOneMessage",e.length)),n()},progress:function(e,t){var n="";t&&(n=a.format(t/1024)),o._uploadProgress.update(e,n)},finished:function(){setTimeout(function(){o._uploadProgress.success(t.ui.texts.get("mainviewFileUploadComplete"))},1e3)},failed:function(){o._uploadProgress.failure(t.ui.texts.get("mainviewFileUploadFailed"))}}})},["localize"])}},this.PublicUploaderProgress=function(e){var t=this;return t._$title=e.find(".title"),t._$speed=e.find(".speed"),t._$bar=e.find(".bar"),{start:function(n){e.removeClass("success failure"),t._$title.text(n?n:""),t._$speed.text(""),t._$bar.css("width","0%")},update:function(e,n){t._$bar.css("width",e+"%"),t._$speed.text(n?n:"")},success:function(n){e.addClass("success"),t._$bar.css("width","0%"),t._$title.text(n),t._$speed.text("")},failure:function(n){e.addClass("failure"),t._$title.text(n),t._$speed.text("")}}},this.renderItemContextDetails=function(e,r,i,s){i.addClass("loading"),t.templates.load("shares-content",t.helpers.noncachedUrl(t.plugins.url("Share","content.html"))).done(function(){i.removeClass("loading"),t.dom.template("mollify-tmpl-shares",{item:r}).appendTo(i),n.loadShares(r).done(function(e){n.initContent(r,e,i)})})},this.loadShares=function(e){return e?t.service.get("share/items/"+e.id).done(function(e){n.refreshShares(e)}):t.service.get("share/all/")},this.refreshShares=function(e){n.shares=e,n.shareIds=[];for(var t=0,r=n.shares.length;t<r;t++)n.shareIds.push(e[t].id)},this.getShare=function(e){return n.shares[n.shareIds.indexOf(e)]},this.initContent=function(r,i,s){var o=r.shareTitle?r.shareTitle:t.ui.texts.get(r.is_file?"shareDialogShareFileTitle":"shareDialogShareFolderTitle");e("#share-item-title").html(o),e("#share-item-name").html(r.name),e("#share-dialog-content").removeClass("loading"),e("#share-new").click(function(){n.onAddShare(r)}),n._context=t.ui.controls.slidePanel(e("#share-list"),{relative:!0}),n.updateShareList(r)},this.getShareLink=function(e){return t.App.getPageUrl("share/"+e.id)},this.updateShareList=function(r){e("#share-items").empty();if(n.shares.length===0){e("#share-items").html('<div class="no-share-items">'+t.ui.texts.get("shareDialogNoShares")+"</div>");return}var i={itemClass:function(){var e="item-share";this.data.active||(e+=" inactive");if(!this.data.name||this.data.name.length===0)e+=" unnamed";return e},link:function(){return n.getShareLink(this.data)}};t.dom.template("share-template",n.shares,i).appendTo("#share-items"),t.ui.process(e("#share-list"),["localize"]);if(!t.ui.clipboard)e(".share-link-copy").hide();else{var s={onMouseOver:function(e,t){t.setHandCursor(!0),e.addClass("hover")},onMouseOut:function(e){e.removeClass("hover")}};e.each(e(".share-link-copy"),function(r,i){var o=e(i).tmplItem().data;t.ui.clipboard.enableCopy(e(i),n.getShareLink(o),s)})}e(".share-link-toggle").click(function(){var t=e(this).tmplItem().data;if(!t.active)return;var n=e(this).parent(),r=n.parent().siblings(".share-link-content"),i=r.parent();return e(".share-link-content").not(r).hide(),e(".item-share").not(i).removeClass("active"),i.toggleClass("active"),r.slideToggle(),!1}),e(".item-share").hover(function(){e(".item-share").removeClass("hover"),e(this).addClass("hover")},function(){}),e(".share-edit").click(function(t){var i=e(this).tmplItem().data;n.onEditShare(r,i)}),e(".share-remove").click(function(t){var i=e(this).tmplItem().data;n.removeShare(r,i)})},this.openContextContent=function(e,r,i){var s=n._context.getContentElement().empty();t.dom.template(r,i).appendTo(s),t.ui.process(s,["localize"]),t.ui.controls.datepicker("share-validity-expirationdate-value",{format:t.ui.texts.get("shortDateTimeFormat"),time:!0}),n._context.show(!1,280)},this.closeAddEdit=function(){n._context.hide()},this.onAddShare=function(r){n.openContextContent("add-share-title","share-context-addedit-template"),e("#share-general-name").val(""),e("#share-general-active").attr("checked",!0),e("#share-access-norestriction").attr("checked",!0),e("#share-access-public-password-value").attr("placeholder",t.ui.texts.get("shareDialogShareAccessEnterPwTitle")),e("#share-addedit-btn-ok").click(function(){e("#share-access-public-password-value").removeClass("error");var t=e("#share-general-name").val(),i=e("#share-general-active").is(":checked"),s=e("#share-validity-expirationdate-value").data("mollify-datepicker").get(),o=!1;if(e("#share-access-private-loggedin").is(":checked"))o={type:"private"};else if(e("#share-access-public-password").is(":checked")){var u=e("#share-access-public-password-value"
).val();if(!u||u.length===0){e("#share-access-public-password-value").addClass("error");return}o={type:"pw",value:u}}e("#share-items").empty().append('<div class="loading"/>'),n.closeAddEdit(),n.addShare(r,t||"",s,i,o)}),e("#share-addedit-btn-cancel").click(function(){n.closeAddEdit()})},this.onEditShare=function(r,i){n.openContextContent("edit-share-title","share-context-addedit-template",{edit:!0}),e("#share-general-name").val(i.name),e("#share-general-active").attr("checked",i.active);var s=i.restriction=="pw";i.restriction=="pw"?e("#share-access-public-password").attr("checked",!0):i.restriction=="private"?e("#share-access-private-loggedin").attr("checked",!0):e("#share-access-norestriction").attr("checked",!0),i.expiration&&e("#share-validity-expirationdate-value").data("mollify-datepicker").set(t.helpers.parseInternalTime(i.expiration)),s?e("#share-access-public-password-value").attr("placeholder",t.ui.texts.get("shareDialogShareAccessChangePwTitle")):e("#share-access-public-password-value").attr("placeholder",t.ui.texts.get("shareDialogShareAccessEnterPwTitle")),e("#share-addedit-btn-ok").click(function(){var t=e("#share-general-name").val(),o=e("#share-general-active").is(":checked"),u=e("#share-validity-expirationdate-value").data("mollify-datepicker").get(),a=!1;if(e("#share-access-private-loggedin").is(":checked"))a={type:"private"};else if(e("#share-access-public-password").is(":checked")){var f=e("#share-access-public-password-value").val();if(!s&&(!f||f.length===0)){e("#share-access-public-password-value").addClass("error");return}a={type:"pw",value:f}}e("#share-items").empty().append('<div class="loading"/>'),n.closeAddEdit(),n.editShare(r,i.id,t||"",u,o,a)}),e("#share-addedit-btn-cancel").click(function(){n.closeAddEdit()})},this.onOpenShares=function(e){t.templates.load("shares-content",t.helpers.noncachedUrl(t.plugins.url("Share","content.html"))).done(function(){t.ui.dialogs.custom({resizable:!0,initSize:[600,470],title:e.shareTitle?e.shareTitle:t.ui.texts.get(e.is_file?"shareDialogShareFileTitle":"shareDialogShareFolderTitle"),content:t.dom.template("mollify-tmpl-shares",{item:e,bubble:!1}),buttons:[{id:"no",title:t.ui.texts.get("dialogClose")}],"on-button":function(e,t){t.close(),n.d=!1},"on-show":function(t,r){n.d=t,n.loadShares(e).done(function(t){n.initContent(e,t,r)})}})})},this.addShare=function(e,r,i,s,o){return t.service.post("share/",{item:e.id,name:r,expiration:t.helpers.formatInternalTime(i),active:s,restriction:o}).done(function(t){n.refreshShares(t),n.updateShareList(e)}).fail(n.d.close)},this.editShare=function(e,r,i,s,o,u){return t.service.put("share/"+r,{id:r,name:i,expiration:t.helpers.formatInternalTime(s),active:o,restriction:u}).done(function(a){var f=n.getShare(r);f.name=i,f.active=o,f.expiration=t.helpers.formatInternalTime(s),f.restriction=u?u.type:!1,n.updateShareList(e)}).fail(n.d.close)},this.removeShare=function(e,r){return t.service.del("share/"+r.id).done(function(t){var i=n.shareIds.indexOf(r.id);n.shareIds.splice(i,1),n.shares.splice(i,1),n.updateShareList(e)}).fail(n.d.close)},this.removeAllItemShares=function(e){return t.service.del("share/items/"+e.id)},this.getActionValidationMessages=function(n,r,i){var s=[];return e.each(r,function(e,n){var r;if(n.reason=="item_shared")r=t.ui.texts.get("pluginShareActionValidationDeleteShared",n.item.name);else{if(n.reason!="item_shared_others")return;r=t.ui.texts.get("pluginShareActionValidationDeleteSharedOthers",n.item.name)}s.push({message:r,acceptable:n.acceptable,acceptKey:n.acceptKey})}),s},this.getListCellContent=function(e,n){if(!e.id||e.id.length===0||!n||!n["plugin-share-info"])return"";var r=n["plugin-share-info"][e.id];return r?r.own>0?"<div id='item-share-info-"+e.id+"' class='filelist-item-share-info'><i class='icon-external-link'></i>&nbsp;"+r.own+"</div>":"<div id='item-share-info-"+e.id+"' class='filelist-item-share-info others' title='"+t.ui.texts.get("pluginShareFilelistColOtherShared")+"'><i class='icon-external-link'></i></div>":"<div id='item-share-info-"+e.id+"' class='filelist-item-share-info empty'></div>"},this._updateListCellContent=function(e,t){},this.showShareBubble=function(r,i){n.d=t.ui.controls.dynamicBubble({element:i,title:r.name,container:e("#mollify-filelist-main-items")}),t.templates.load("shares-content",t.helpers.noncachedUrl(t.plugins.url("Share","content.html"))).done(function(){n.d.content(t.dom.template("mollify-tmpl-shares",{item:r,bubble:!0})),n.loadShares(r).done(function(e){n.initContent(r,e,n.d.element()),n.d.position()})})},this.onActivateConfigView=function(e,r){var i=!1,s=!1,o=[],u=!1,a=function(){r.showLoading(!0),n.loadShares().done(function(e){i=e.shares[t.session.user_id],s=e.items,o=e.invalid,u.table.set(s),r.showLoading(!1)})},f=function(e){return o.length===0?!0:o.indexOf(e.id)<0};u=new t.view.ConfigListView(e,{table:{key:"id",columns:[{id:"icon",title:"",valueMapper:function(e){return f(e)?'<i class="icon-file"></i>':'<i class="icon-exclamation"></i>'}},{id:"name",title:t.ui.texts.get("fileListColumnTitleName")},{id:"count",title:t.ui.texts.get("pluginShareConfigViewCountTitle"),valueMapper:function(e){return i[e.id].length}},{id:"edit",title:"",type:"action",valueMapper:function(e){return f(e)?'<i class="icon-edit"></i>':""}},{id:"remove",title:"",type:"action",content:'<i class="icon-trash"></i>'}],onRow:function(e,t){f(t)||e.addClass("error")},onRowAction:function(e,t){e=="edit"?n.onOpenShares(t):e=="remove"&&n.removeAllItemShares(t).done(a)}}}),a()},{id:"plugin-share",backendPluginId:"Share",resources:{css:!0},initialize:n.initialize,configViewHandler:{views:function(){return[{viewId:"shares",title:t.ui.texts.get("pluginShareConfigViewNavTitle"),onActivate:n.onActivateConfigView}]}},fileViewHandler:{filelistColumns:function(){return[{id:"share-info","request-id":"plugin-share-info","title-key":"",content:n.getListCellContent,request:function(e){return{}},"on-click":function(t,r){if(!t.id||t.id.length===0||!r||!r["plugin-share-info"])return;var i=r["plugin-share-info"][t.id];if(!i)return;i.own>0&&n.showShareBubble(t,e("#item-share-info-"+t.id))}}]}},itemContextHandler:function(e,t,r){return{actions:[{id:"pluginShare","title-key":"itemContextShareMenuTitle",icon:"external-link",callback:function(){n.onOpenShares(e)}}]}},actionValidationHandler:function(){return{getValidationMessages:n.getActionValidationMessages}},openShares:n.onOpenShares}},t.plugin.SendViaEmailPlugin=function(){var t=this;return this.initialize=function(){},{id:"plugin-sendviaemail",initialize:t.initialize,itemContextHandler:function(e,t,n){return e.is_file?{actions:[{"title-key":"actionSendViaEmailSingle",callback:function(){}}]}:!1},itemCollectionHandler:function(t){var n=!1;return e.each(t,function(e,t){if(!t.is_file)return n=!0,!1}),n?!1:{actions:[{"title-key":"actionSendViaEmailMultiple",callback:function(){}}]}}}},t.plugin.RegistrationPlugin=function(){var n=this;return this.initialize=function(){t.App.registerView("registration",{getView:function(e,t){return e.length!=2?!1:e[1]=="new"?new n.NewRegistrationView(t):e[1]=="confirm"?new n.ConfirmRegistrationView(t):!1}})},this.NewRegistrationView=function(){var n=this;this.init=function(r){t.dom.loadContentInto(r,t.plugins.url("Registration","registration_create.html"),function(){e("#register-new-button").click(n.onRegister),e("#registration-new-name").focus()},["localize"])},this.onRegister=function(){e(".control-group").removeClass("error");var n=e("#registration-new-name").val(),r=e("#registration-new-pw").val(),i=e("#registration-new-pw-confirm").val(),s=e("#registration-new-email").val(),o=!0;if(!n||n.length===0)e("#registration-new-name").closest(".control-group").addClass("error"),o=!1;if(!r||r.length===0)e("#registration-new-pw").closest(".control-group").addClass("error"),o=!1;if(!i||i.length===0)e("#registration-new-pw-confirm").closest(".control-group").addClass("error"),o=!1;if(!s||s.length===0)e("#registration-new-email").closest(".control-group").addClass("error"),o=!1;if(!o)return;if(r!=i){e("#registration-new-pw").closest(".control-group").addClass("error"),e("#registration-new-pw-confirm").closest(".control-group").addClass("error");return}t.service.post("registration/create",{name:n,password:window.Base64.encode(r),email:s,data:null}).done(function(){e("#mollify-registration-form").hide(),e("#mollify-registration-main").addClass("wide"),e("#mollify-registration-success").show()}).fail(function(){this.handled=!0,t.ui.dialogs.error({message:t.ui.texts.get("registrationFailed")})})}},this.ConfirmRegistrationView=function(n){var r=this;this.init=function(i){t.dom.loadContentInto(i,t.plugins.url("Registration","registration_confirm.html"),function(){if(!n.email||n.email.length===0){e("#mollify-registration-main").addClass("complete").empty().append(t.dom.template("mollify-tmpl-registration-errormessage",{message:t.ui.texts.get("registrationInvalidConfirm")}));return}r._email=n.email,n.key&&n.key.length>0?r._confirm(r._email,n.key):(e("#mollify-registration-confirm-form").show(),e("#registration-confirm-email").val(r._email),e("#register-confirm-button").click(r.onConfirm),e("#registration-confirm-key").focus())},["localize"])},this.onConfirm=function(){e(".control-group").removeClass("error");var t=e("#registration-confirm-key").val(),n=!0;if(!t||t.length===0)e("#registration-confirm-key").closest(".control-group").addClass("error"),n=!1;if(!n)return;r._confirm(r._email,t,!0)},this._confirm=function(n,r,i){e("#mollify-registration-main").addClass("loading"),t.service.post("registration/confirm",{email:n,key:r}).done(function(t){e("#mollify-registration-confirm-form").hide(),e("#mollify-registration-main").removeClass("loading").addClass("wide"),t.require_approval?e("#mollify-registration-confirm-success-wait-approval").show():e("#mollify-registration-confirm-success").show()}).fail(function(n){e("#mollify-registration-main").removeClass("loading"),this.handled=!0,i?t.ui.dialogs.error({message:t.ui.texts.get("registrationConfirmFailed")}):e("#mollify-registration-main").addClass("wide").empty().append(t.dom.template("mollify-tmpl-registration-errormessage",{message:t.ui.texts.get("registrationConfirmFailed")}))})}},{id:"plugin-registration",initialize:n.initialize,show:function(){t.App.openPage("registration/new")}}}}(window.jQuery,window.mollify);